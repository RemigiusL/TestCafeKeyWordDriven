"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const os_1 = __importDefault(require("os"));
const chrome_remote_interface_1 = __importDefault(require("chrome-remote-interface"));
const client_functions_1 = require("../../../utils/client-functions");
const DOWNLOADS_DIR = path_1.default.join(os_1.default.homedir(), 'Downloads');
async function getActiveTab(cdpPort, browserId) {
    const tabs = await chrome_remote_interface_1.default.listTabs({ port: cdpPort });
    return tabs.filter(t => t.type === 'page' && t.url.includes(browserId))[0];
}
async function setEmulationBounds({ client, config, viewportSize, emulatedDevicePixelRatio }) {
    await client.Emulation.setDeviceMetricsOverride({
        width: viewportSize.width,
        height: viewportSize.height,
        deviceScaleFactor: emulatedDevicePixelRatio,
        mobile: config.mobile,
        // @ts-ignore Specify this property for backward compatibility with older protocol versions
        fitWindow: false
    });
    await client.Emulation.setVisibleSize({ width: viewportSize.width, height: viewportSize.height });
}
async function setEmulation(runtimeInfo) {
    const { client, config } = runtimeInfo;
    if (config.userAgent !== void 0)
        await client.Network.setUserAgentOverride({ userAgent: config.userAgent });
    if (config.touch !== void 0) {
        const touchConfig = {
            enabled: config.touch,
            configuration: config.mobile ? 'mobile' : 'desktop',
            maxTouchPoints: 1
        };
        if (client.Emulation.setEmitTouchEventsForMouse)
            await client.Emulation.setEmitTouchEventsForMouse(touchConfig);
        if (client.Emulation.setTouchEmulationEnabled)
            await client.Emulation.setTouchEmulationEnabled(touchConfig);
    }
    await resizeWindow({ width: config.width, height: config.height }, runtimeInfo);
}
async function enableDownloads({ client }) {
    await client.Page.setDownloadBehavior({
        behavior: 'allow',
        downloadPath: DOWNLOADS_DIR
    });
}
async function getScreenshotData({ client }) {
    const screenshotData = await client.Page.captureScreenshot({});
    return Buffer.from(screenshotData.data, 'base64');
}
exports.getScreenshotData = getScreenshotData;
async function createClient(runtimeInfo) {
    const { browserId, config, cdpPort } = runtimeInfo;
    let tab = null;
    let client = null;
    try {
        tab = await getActiveTab(cdpPort, browserId);
        if (!tab)
            return;
        client = await chrome_remote_interface_1.default({ target: tab, port: cdpPort });
    }
    catch (e) {
        return;
    }
    runtimeInfo.tab = tab;
    runtimeInfo.client = client;
    await client.Page.enable();
    await client.Network.enable({});
    await client.Runtime.enable();
    const devicePixelRatioQueryResult = await client.Runtime.evaluate({ expression: 'window.devicePixelRatio' });
    runtimeInfo.originalDevicePixelRatio = devicePixelRatioQueryResult.result.value;
    runtimeInfo.emulatedDevicePixelRatio = config.scaleFactor || runtimeInfo.originalDevicePixelRatio;
    if (config.emulation)
        await setEmulation(runtimeInfo);
    if (config.headless)
        await enableDownloads(runtimeInfo);
}
exports.createClient = createClient;
function isHeadlessTab({ tab, config }) {
    return tab && config.headless;
}
exports.isHeadlessTab = isHeadlessTab;
async function closeTab({ tab, cdpPort }) {
    await chrome_remote_interface_1.default.closeTab({ id: tab.id, port: cdpPort });
}
exports.closeTab = closeTab;
async function updateMobileViewportSize(runtimeInfo) {
    const windowDimensionsQueryResult = await runtimeInfo.client.Runtime.evaluate({
        expression: `(${client_functions_1.GET_WINDOW_DIMENSIONS_INFO_SCRIPT})()`,
        returnByValue: true
    });
    const windowDimensions = windowDimensionsQueryResult.result.value;
    runtimeInfo.viewportSize.width = windowDimensions.outerWidth;
    runtimeInfo.viewportSize.height = windowDimensions.outerHeight;
}
exports.updateMobileViewportSize = updateMobileViewportSize;
async function resizeWindow(newDimensions, runtimeInfo) {
    const { browserId, config, viewportSize, providerMethods } = runtimeInfo;
    const currentWidth = viewportSize.width;
    const currentHeight = viewportSize.height;
    const newWidth = newDimensions.width || currentWidth;
    const newHeight = newDimensions.height || currentHeight;
    if (!config.headless)
        await providerMethods.resizeLocalBrowserWindow(browserId, newWidth, newHeight, currentWidth, currentHeight);
    viewportSize.width = newWidth;
    viewportSize.height = newHeight;
    if (config.emulation)
        await setEmulationBounds(runtimeInfo);
}
exports.resizeWindow = resizeWindow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jZHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxnREFBd0I7QUFDeEIsNENBQW9CO0FBQ3BCLHNGQUFtRDtBQUNuRCxzRUFBb0Y7QUF3Q3BGLE1BQU0sYUFBYSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsWUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBRTNELEtBQUssVUFBVSxZQUFZLENBQUUsT0FBZSxFQUFFLFNBQWlCO0lBQzNELE1BQU0sSUFBSSxHQUFHLE1BQU0saUNBQVksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUU1RCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLE1BQU0sSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQy9FLENBQUM7QUFFRCxLQUFLLFVBQVUsa0JBQWtCLENBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSx3QkFBd0IsRUFBZTtJQUN0RyxNQUFNLE1BQU0sQ0FBQyxTQUFTLENBQUMsd0JBQXdCLENBQUM7UUFDNUMsS0FBSyxFQUFjLFlBQVksQ0FBQyxLQUFLO1FBQ3JDLE1BQU0sRUFBYSxZQUFZLENBQUMsTUFBTTtRQUN0QyxpQkFBaUIsRUFBRSx3QkFBd0I7UUFDM0MsTUFBTSxFQUFhLE1BQU0sQ0FBQyxNQUFNO1FBQ2hDLDJGQUEyRjtRQUMzRixTQUFTLEVBQVUsS0FBSztLQUMzQixDQUFDLENBQUM7SUFFSCxNQUFNLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEVB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V0FBVyxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO0FBQ25FLENBQUM7QUFWRCw0REFVQztBQUVNLEtBQUssVUFBVSxZQUFZLENBQUUsYUFBbUIsRUFBRSxXQUF3QjtJQUM3RSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLEdBQUcsV0FBVyxDQUFDO0lBRXpFLE1BQU0sWUFBWSxHQUFJLFlBQVksQ0FBQyxLQUFLLENBQUM7SUFDekMsTUFBTSxhQUFhLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQztJQUMxQyxNQUFNLFFBQVEsR0FBUSxhQUFhLENBQUMsS0FBSyxJQUFJLFlBQVksQ0FBQztJQUMxRCxNQUFNLFNBQVMsR0FBTyxhQUFhLENBQUMsTUFBTSxJQUFJLGFBQWEsQ0FBQztJQUU1RCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7UUFDaEIsTUFBTSxlQUFlLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRWhILFlBQVksQ0FBQyxLQUFLLEdBQUksUUFBUSxDQUFDO0lBQy9CLFlBQVksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO0lBRWhDLElBQUksTUFBTSxDQUFDLFNBQVM7UUFDaEIsTUFBTSxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBaEJELG9DQWdCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCByZW1vdGVDaHJvbWUgZnJvbSAnY2hyb21lLXJlbW90ZS1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvY2xpZW50LWZ1bmN0aW9ucyc7XG5cbmludGVyZmFjZSBTaXplIHtcbiAgICB3aWR0aDogbnVtYmVyO1xuICAgIGhlaWdodDogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgQ29uZmlnIHtcbiAgICBoZWFkbGVzczogYm9vbGVhbjtcbiAgICBtb2JpbGU6IGJvb2xlYW47XG4gICAgZW11bGF0aW9uOiBmYWxzZTtcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmc7XG4gICAgdG91Y2g/OiBib29sZWFuO1xuICAgIHdpZHRoOiBudW1iZXI7XG4gICAgaGVpZ2h0OiBudW1iZXI7XG4gICAgc2NhbGVGYWN0b3I6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFByb3ZpZGVyTWV0aG9kcyB7XG4gICAgcmVzaXplTG9jYWxCcm93c2VyV2luZG93IChicm93c2VySWQ6IHN0cmluZywgbmV3V2lkdGg6IG51bWJlciwgbmV3SGVpZ2h0OiBudW1iZXIsIGN1cnJlbnRXaWR0aDogbnVtYmVyLCBjdXJyZW50SGVpZ2h0OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5pbnRlcmZhY2UgUnVudGltZUluZm8ge1xuICAgIGJyb3dzZXJJZDogc3RyaW5nO1xuICAgIGNkcFBvcnQ6IG51bWJlcjtcbiAgICBjbGllbnQ6IHJlbW90ZUNocm9tZS5Qcm90b2NvbEFwaTtcbiAgICB0YWI6IHJlbW90ZUNocm9tZS5UYXJnZXRJbmZvO1xuICAgIGNvbmZpZzogQ29uZmlnO1xuICAgIHZpZXdwb3J0U2l6ZTogU2l6ZTtcbiAgICBlbXVsYXRlZERldmljZVBpeGVsUmF0aW86IG51bWJlcjtcbiAgICBvcmlnaW5hbERldmljZVBpeGVsUmF0aW86IG51bWJlcjtcbiAgICBwcm92aWRlck1ldGhvZHM6IFByb3ZpZGVyTWV0aG9kcztcbn1cblxuaW50ZXJmYWNlIFRvdWNoQ29uZmlnT3B0aW9ucyB7XG4gICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICBjb25maWd1cmF0aW9uOiAnZGVza3RvcCcgfCAnbW9iaWxlJztcbiAgICBtYXhUb3VjaFBvaW50czogbnVtYmVyO1xufVxuXG5jb25zdCBET1dOTE9BRFNfRElSID0gcGF0aC5qb2luKG9zLmhvbWVkaXIoKSwgJ0Rvd25sb2FkcycpO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRBY3RpdmVUYWIgKGNkcFBvcnQ6IG51bWJlciwgYnJvd3NlcklkOiBzdHJpbmcpOiBQcm9taXNlPHJlbW90ZUNocm9tZS5UYXJnZXRJbmZvPiB7XG4gICAgY29uc3QgdGFicyA9IGF3YWl0IHJlbW90ZUNocm9tZS5saXN0VGFicyh7IHBvcnQ6IGNkcFBvcnQgfSk7XG5cbiAgICByZXR1cm4gdGFicy5maWx0ZXIodCA9PiB0LnR5cGUgPT09ICdwYWdlJyAmJiB0LnVybC5pbmNsdWRlcyhicm93c2VySWQpKVswXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uQm91bmRzICh7IGNsaWVudCwgY29uZmlnLCB2aWV3cG9ydFNpemUsIGVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyB9OiBSdW50aW1lSW5mbyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IGNsaWVudC5FbXVsYXRpb24uc2V0RGV2aWNlTWV0cmljc092ZXJyaWRlKHtcbiAgICAgICAgd2lkdGg6ICAgICAgICAgICAgIHZpZXdwb3J0U2l6ZS53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiAgICAgICAgICAgIHZpZXdwb3J0U2l6ZS5oZWlnaHQsXG4gICAgICAgIGRldmljZVNjYWxlRmFjdG9yOiBlbXVsYXRlZERldmljZVBpeGVsUmF0aW8sXG4gICAgICAgIG1vYmlsZTogICAgICAgICAgICBjb25maWcubW9iaWxlLFxuICAgICAgICAvLyBAdHMtaWdub3JlIFNwZWNpZnkgdGhpcyBwcm9wZXJ0eSBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIG9sZGVyIHByb3RvY29sIHZlcnNpb25zXG4gICAgICAgIGZpdFdpbmRvdzogICAgICAgICBmYWxzZVxuICAgIH0pO1xuXG4gICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRWaXNpYmxlU2l6ZSh7IHdpZHRoOiB2aWV3cG9ydFNpemUud2lkdGgsIGhlaWdodDogdmlld3BvcnRTaXplLmhlaWdodCB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uIChydW50aW1lSW5mbzogUnVudGltZUluZm8pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB7IGNsaWVudCwgY29uZmlnIH0gPSBydW50aW1lSW5mbztcblxuICAgIGlmIChjb25maWcudXNlckFnZW50ICE9PSB2b2lkIDApXG4gICAgICAgIGF3YWl0IGNsaWVudC5OZXR3b3JrLnNldFVzZXJBZ2VudE92ZXJyaWRlKHsgdXNlckFnZW50OiBjb25maWcudXNlckFnZW50IH0pO1xuXG4gICAgaWYgKGNvbmZpZy50b3VjaCAhPT0gdm9pZCAwKSB7XG4gICAgICAgIGNvbnN0IHRvdWNoQ29uZmlnOiBUb3VjaENvbmZpZ09wdGlvbnMgPSB7XG4gICAgICAgICAgICBlbmFibGVkOiAgICAgICAgY29uZmlnLnRvdWNoLFxuICAgICAgICAgICAgY29uZmlndXJhdGlvbjogIGNvbmZpZy5tb2JpbGUgPyAnbW9iaWxlJyA6ICdkZXNrdG9wJyxcbiAgICAgICAgICAgIG1heFRvdWNoUG9pbnRzOiAxXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGNsaWVudC5FbXVsYXRpb24uc2V0RW1pdFRvdWNoRXZlbnRzRm9yTW91c2UpXG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuRW11bGF0aW9uLnNldEVtaXRUb3VjaEV2ZW50c0Zvck1vdXNlKHRvdWNoQ29uZmlnKTtcblxuICAgICAgICBpZiAoY2xpZW50LkVtdWxhdGlvbi5zZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuRW11bGF0aW9uLnNldFRvdWNoRW11bGF0aW9uRW5hYmxlZCh0b3VjaENvbmZpZyk7XG4gICAgfVxuXG4gICAgYXdhaXQgcmVzaXplV2luZG93KHsgd2lkdGg6IGNvbmZpZy53aWR0aCwgaGVpZ2h0OiBjb25maWcuaGVpZ2h0IH0sIHJ1bnRpbWVJbmZvKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZW5hYmxlRG93bmxvYWRzICh7IGNsaWVudCB9OiBSdW50aW1lSW5mbyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IGNsaWVudC5QYWdlLnNldERvd25sb2FkQmVoYXZpb3Ioe1xuICAgICAgICBiZWhhdmlvcjogICAgICdhbGxvdycsXG4gICAgICAgIGRvd25sb2FkUGF0aDogRE9XTkxPQURTX0RJUlxuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U2NyZWVuc2hvdERhdGEgKHsgY2xpZW50IH06IFJ1bnRpbWVJbmZvKTogUHJvbWlzZTxCdWZmZXI+IHtcbiAgICBjb25zdCBzY3JlZW5zaG90RGF0YSA9IGF3YWl0IGNsaWVudC5QYWdlLmNhcHR1cmVTY3JlZW5zaG90KHt9KTtcblxuICAgIHJldHVybiBCdWZmZXIuZnJvbShzY3JlZW5zaG90RGF0YS5kYXRhLCAnYmFzZTY0Jyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVDbGllbnQgKHJ1bnRpbWVJbmZvOiBSdW50aW1lSW5mbyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHsgYnJvd3NlcklkLCBjb25maWcsIGNkcFBvcnQgfSA9IHJ1bnRpbWVJbmZvO1xuXG4gICAgbGV0IHRhYiAgICA9IG51bGw7XG4gICAgbGV0IGNsaWVudCA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgICB0YWIgPSBhd2FpdCBnZXRBY3RpdmVUYWIoY2RwUG9ydCwgYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoIXRhYilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjbGllbnQgPSBhd2FpdCByZW1vdGVDaHJvbWUoeyB0YXJnZXQ6IHRhYiwgcG9ydDogY2RwUG9ydCB9KTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJ1bnRpbWVJbmZvLnRhYiAgICA9IHRhYjtcbiAgICBydW50aW1lSW5mby5jbGllbnQgPSBjbGllbnQ7XG5cbiAgICBhd2FpdCBjbGllbnQuUGFnZS5lbmFibGUoKTtcbiAgICBhd2FpdCBjbGllbnQuTmV0d29yay5lbmFibGUoe30pO1xuICAgIGF3YWl0IGNsaWVudC5SdW50aW1lLmVuYWJsZSgpO1xuXG4gICAgY29uc3QgZGV2aWNlUGl4ZWxSYXRpb1F1ZXJ5UmVzdWx0ID0gYXdhaXQgY2xpZW50LlJ1bnRpbWUuZXZhbHVhdGUoeyBleHByZXNzaW9uOiAnd2luZG93LmRldmljZVBpeGVsUmF0aW8nIH0pO1xuXG4gICAgcnVudGltZUluZm8ub3JpZ2luYWxEZXZpY2VQaXhlbFJhdGlvID0gZGV2aWNlUGl4ZWxSYXRpb1F1ZXJ5UmVzdWx0LnJlc3VsdC52YWx1ZTtcbiAgICBydW50aW1lSW5mby5lbXVsYXRlZERldmljZVBpeGVsUmF0aW8gPSBjb25maWcuc2NhbGVGYWN0b3IgfHwgcnVudGltZUluZm8ub3JpZ2luYWxEZXZpY2VQaXhlbFJhdGlvO1xuXG4gICAgaWYgKGNvbmZpZy5lbXVsYXRpb24pXG4gICAgICAgIGF3YWl0IHNldEVtdWxhdGlvbihydW50aW1lSW5mbyk7XG5cbiAgICBpZiAoY29uZmlnLmhlYWRsZXNzKVxuICAgICAgICBhd2FpdCBlbmFibGVEb3dubG9hZHMocnVudGltZUluZm8pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNIZWFkbGVzc1RhYiAoeyB0YWIsIGNvbmZpZyB9OiBSdW50aW1lSW5mbyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0YWIgJiYgY29uZmlnLmhlYWRsZXNzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xvc2VUYWIgKHsgdGFiLCBjZHBQb3J0IH06IFJ1bnRpbWVJbmZvKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgcmVtb3RlQ2hyb21lLmNsb3NlVGFiKHsgaWQ6IHRhYi5pZCwgcG9ydDogY2RwUG9ydCB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZU1vYmlsZVZpZXdwb3J0U2l6ZSAocnVudGltZUluZm86IFJ1bnRpbWVJbmZvKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgd2luZG93RGltZW5zaW9uc1F1ZXJ5UmVzdWx0ID0gYXdhaXQgcnVudGltZUluZm8uY2xpZW50LlJ1bnRpbWUuZXZhbHVhdGUoe1xuICAgICAgICBleHByZXNzaW9uOiAgICBgKCR7R0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUfSkoKWAsXG4gICAgICAgIHJldHVybkJ5VmFsdWU6IHRydWVcbiAgICB9KTtcblxuICAgIGNvbnN0IHdpbmRvd0RpbWVuc2lvbnMgPSB3aW5kb3dEaW1lbnNpb25zUXVlcnlSZXN1bHQucmVzdWx0LnZhbHVlO1xuXG4gICAgcnVudGltZUluZm8udmlld3BvcnRTaXplLndpZHRoICA9IHdpbmRvd0RpbWVuc2lvbnMub3V0ZXJXaWR0aDtcbiAgICBydW50aW1lSW5mby52aWV3cG9ydFNpemUuaGVpZ2h0ID0gd2luZG93RGltZW5zaW9ucy5vdXRlckhlaWdodDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlc2l6ZVdpbmRvdyAobmV3RGltZW5zaW9uczogU2l6ZSwgcnVudGltZUluZm86IFJ1bnRpbWVJbmZvKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgeyBicm93c2VySWQsIGNvbmZpZywgdmlld3BvcnRTaXplLCBwcm92aWRlck1ldGhvZHMgfSA9IHJ1bnRpbWVJbmZvO1xuXG4gICAgY29uc3QgY3VycmVudFdpZHRoICA9IHZpZXdwb3J0U2l6ZS53aWR0aDtcbiAgICBjb25zdCBjdXJyZW50SGVpZ2h0ID0gdmlld3BvcnRTaXplLmhlaWdodDtcbiAgICBjb25zdCBuZXdXaWR0aCAgICAgID0gbmV3RGltZW5zaW9ucy53aWR0aCB8fCBjdXJyZW50V2lkdGg7XG4gICAgY29uc3QgbmV3SGVpZ2h0ICAgICA9IG5ld0RpbWVuc2lvbnMuaGVpZ2h0IHx8IGN1cnJlbnRIZWlnaHQ7XG5cbiAgICBpZiAoIWNvbmZpZy5oZWFkbGVzcylcbiAgICAgICAgYXdhaXQgcHJvdmlkZXJNZXRob2RzLnJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdyhicm93c2VySWQsIG5ld1dpZHRoLCBuZXdIZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCk7XG5cbiAgICB2aWV3cG9ydFNpemUud2lkdGggID0gbmV3V2lkdGg7XG4gICAgdmlld3BvcnRTaXplLmhlaWdodCA9IG5ld0hlaWdodDtcblxuICAgIGlmIChjb25maWcuZW11bGF0aW9uKVxuICAgICAgICBhd2FpdCBzZXRFbXVsYXRpb25Cb3VuZHMocnVudGltZUluZm8pO1xufVxuIl19