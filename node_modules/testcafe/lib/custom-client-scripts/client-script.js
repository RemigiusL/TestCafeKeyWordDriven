"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const promisified_functions_1 = require("../utils/promisified-functions");
const runtime_1 = require("../errors/runtime");
const types_1 = require("../errors/types");
const path_1 = require("path");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const crypto_1 = require("crypto");
const BEAUTIFY_REGEXP = /[/.:\s\\]/g;
const BEAUTIFY_CHAR = '_';
const EMPTY_CONTENT_STR = '{ content: <empty> }';
const CONTENT_STR_MAX_LENGTH = 30;
const CONTENT_ELLIPSIS_STR = '...';
const URL_UNIQUE_PART_LENGTH = 7;
class ClientScript {
    constructor(init, basePath) {
        this.init = init || null;
        this.url = testcafe_hammerhead_1.generateUniqueId(URL_UNIQUE_PART_LENGTH);
        this.content = '';
        this.path = null;
        this.module = null;
        this.hash = null;
        this.page = testcafe_hammerhead_1.RequestFilterRule.ANY;
        this.basePath = basePath;
    }
    _resolvePath(path) {
        let resolvedPath = null;
        if (path_1.isAbsolute(path))
            resolvedPath = path;
        else {
            if (!this.basePath)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptBasePathIsNotSpecified);
            resolvedPath = path_1.join(this.basePath, path);
        }
        return resolvedPath;
    }
    async _loadFromPath(path) {
        const resolvedPath = this._resolvePath(path);
        try {
            this.path = resolvedPath;
            this.content = await promisified_functions_1.readFile(this.path);
            this.content = this.content.toString();
            this.url = path || this.url;
        }
        catch (e) {
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.cannotLoadClientScriptFromPath, path);
        }
    }
    async _loadFromModule(name) {
        let resolvedPath = null;
        try {
            resolvedPath = require.resolve(name);
        }
        catch (e) {
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptModuleEntryPointPathCalculationError, e.message);
        }
        await this._loadFromPath(resolvedPath);
        this.module = name;
    }
    _prepareUrl() {
        this.url = this.url.replace(BEAUTIFY_REGEXP, BEAUTIFY_CHAR).toLowerCase();
    }
    async load() {
        if (this.init === null)
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptInitializerIsNotSpecified);
        else if (typeof this.init === 'string')
            await this._loadFromPath(this.init);
        else {
            const { path: initPath, content: initContent, module: initModule, page: initPage } = this.init;
            if (initPath && initContent || initPath && initModule || initContent && initModule)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptInitializerMultipleContentSources);
            if (initPath)
                await this._loadFromPath(initPath);
            else if (initModule)
                await this._loadFromModule(initModule);
            else
                this.content = initContent;
            if (initPage)
                this.page = new testcafe_hammerhead_1.RequestFilterRule(initPage);
        }
        this._calculateHash();
        this._prepareUrl();
    }
    _calculateHash() {
        this.hash = crypto_1.createHash('md5').update(this.content).digest();
    }
    _contentToString() {
        let displayContent = '';
        if (this.content.length <= CONTENT_STR_MAX_LENGTH - CONTENT_ELLIPSIS_STR.length)
            displayContent = this.content;
        else
            displayContent = this.content.substring(0, CONTENT_STR_MAX_LENGTH - CONTENT_ELLIPSIS_STR.length) + CONTENT_ELLIPSIS_STR;
        return `{ content: '${displayContent}' }`;
    }
    toString() {
        if (!this.content)
            return EMPTY_CONTENT_STR;
        else if (this.content && !this.path)
            return this._contentToString();
        return `{ path: '${this.path}' }`;
    }
    static get URL_UNIQUE_PART_LENGTH() {
        return URL_UNIQUE_PART_LENGTH;
    }
}
exports.default = ClientScript;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LXNjcmlwdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jdXN0b20tY2xpZW50LXNjcmlwdHMvY2xpZW50LXNjcmlwdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDBFQUEwRDtBQUMxRCwrQ0FBaUQ7QUFDakQsMkNBQWlEO0FBQ2pELCtCQUF3QztBQUN4Qyw2REFBMEU7QUFDMUUsbUNBQW9DO0FBRXBDLE1BQU0sZUFBZSxHQUFHLFlBQVksQ0FBQztBQUNyQyxNQUFNLGFBQWEsR0FBSyxHQUFHLENBQUM7QUFFNUIsTUFBTSxpQkFBaUIsR0FBUSxzQkFBc0IsQ0FBQztBQUN0RCxNQUFNLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztBQUNsQyxNQUFNLG9CQUFvQixHQUFLLEtBQUssQ0FBQztBQUVyQyxNQUFNLHNCQUFzQixHQUFHLENBQUMsQ0FBQztBQUVqQyxNQUFxQixZQUFZO0lBQzdCLFlBQWEsSUFBSSxFQUFFLFFBQVE7UUFDdkIsSUFBSSxDQUFDLElBQUksR0FBTyxJQUFJLElBQUksSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxHQUFHLEdBQVEsc0NBQWdCLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsT0FBTyxHQUFJLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFLLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFPLHVDQUFpQixDQUFDLEdBQUcsQ0FBQztRQUN0QyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBRUQsWUFBWSxDQUFFLElBQUk7UUFDZCxJQUFJLFlBQVksR0FBRyxJQUFJLENBQUM7UUFFeEIsSUFBSSxpQkFBVSxDQUFDLElBQUksQ0FBQztZQUNoQixZQUFZLEdBQUcsSUFB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QVcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxjQUFjO1FBQ1YsSUFBSSxDQUFDLElBQUksR0FBRyxtQkFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEUsQ0FBQztJQUVELGdCQUFnQjtRQUNaLElBQUksY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUV4QixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLHNCQUFzQixHQUFHLG9CQUFvQixDQUFDLE1BQU07WUFDM0UsY0FBYyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7O1lBRTlCLGNBQWMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsc0JBQXNCLEdBQUcsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEdBQUcsb0JBQW9CLENBQUM7UUFFNUgsT0FBTyxlQUFlLGNBQWMsS0FBSyxDQUFDO0lBQzlDLENBQUM7SUFFRCxRQUFRO1FBQ0osSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPO1lBQ2IsT0FBTyxpQkFBaUIsQ0FBQzthQUV4QixJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTtZQUMvQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRW5DLE9BQU8sWUFBWSxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUM7SUFDdEMsQ0FBQztJQUVELE1BQU0sS0FBSyxzQkFBc0I7UUFDN0IsT0FBTyxzQkFBc0IsQ0FBQztJQUNsQyxDQUFDO0NBQ0o7QUFsSEQsK0JBa0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVhZEZpbGUgfSBmcm9tICcuLi91dGlscy9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgaXNBYnNvbHV0ZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgUmVxdWVzdEZpbHRlclJ1bGUsIGdlbmVyYXRlVW5pcXVlSWQgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCB7IGNyZWF0ZUhhc2ggfSBmcm9tICdjcnlwdG8nO1xuXG5jb25zdCBCRUFVVElGWV9SRUdFWFAgPSAvWy8uOlxcc1xcXFxdL2c7XG5jb25zdCBCRUFVVElGWV9DSEFSICAgPSAnXyc7XG5cbmNvbnN0IEVNUFRZX0NPTlRFTlRfU1RSICAgICAgPSAneyBjb250ZW50OiA8ZW1wdHk+IH0nO1xuY29uc3QgQ09OVEVOVF9TVFJfTUFYX0xFTkdUSCA9IDMwO1xuY29uc3QgQ09OVEVOVF9FTExJUFNJU19TVFIgICA9ICcuLi4nO1xuXG5jb25zdCBVUkxfVU5JUVVFX1BBUlRfTEVOR1RIID0gNztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2xpZW50U2NyaXB0IHtcbiAgICBjb25zdHJ1Y3RvciAoaW5pdCwgYmFzZVBhdGgpIHtcbiAgICAgICAgdGhpcy5pbml0ICAgICA9IGluaXQgfHwgbnVsbDtcbiAgICAgICAgdGhpcy51cmwgICAgICA9IGdlbmVyYXRlVW5pcXVlSWQoVVJMX1VOSVFVRV9QQVJUX0xFTkdUSCk7XG4gICAgICAgIHRoaXMuY29udGVudCAgPSAnJztcbiAgICAgICAgdGhpcy5wYXRoICAgICA9IG51bGw7XG4gICAgICAgIHRoaXMubW9kdWxlICAgPSBudWxsO1xuICAgICAgICB0aGlzLmhhc2ggICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5wYWdlICAgICA9IFJlcXVlc3RGaWx0ZXJSdWxlLkFOWTtcbiAgICAgICAgdGhpcy5iYXNlUGF0aCA9IGJhc2VQYXRoO1xuICAgIH1cblxuICAgIF9yZXNvbHZlUGF0aCAocGF0aCkge1xuICAgICAgICBsZXQgcmVzb2x2ZWRQYXRoID0gbnVsbDtcblxuICAgICAgICBpZiAoaXNBYnNvbHV0ZShwYXRoKSlcbiAgICAgICAgICAgIHJlc29sdmVkUGF0aCA9IHBhdGg7XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmJhc2VQYXRoKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2xpZW50U2NyaXB0QmFzZVBhdGhJc05vdFNwZWNpZmllZCk7XG5cbiAgICAgICAgICAgIHJlc29sdmVkUGF0aCA9IGpvaW4odGhpcy5iYXNlUGF0aCwgcGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzb2x2ZWRQYXRoO1xuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkRnJvbVBhdGggKHBhdGgpIHtcbiAgICAgICAgY29uc3QgcmVzb2x2ZWRQYXRoID0gdGhpcy5fcmVzb2x2ZVBhdGgocGF0aCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMucGF0aCAgICA9IHJlc29sdmVkUGF0aDtcbiAgICAgICAgICAgIHRoaXMuY29udGVudCA9IGF3YWl0IHJlYWRGaWxlKHRoaXMucGF0aCk7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQgPSB0aGlzLmNvbnRlbnQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIHRoaXMudXJsICAgICA9IHBhdGggfHwgdGhpcy51cmw7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2Fubm90TG9hZENsaWVudFNjcmlwdEZyb21QYXRoLCBwYXRoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkRnJvbU1vZHVsZSAobmFtZSkge1xuICAgICAgICBsZXQgcmVzb2x2ZWRQYXRoID0gbnVsbDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzb2x2ZWRQYXRoID0gcmVxdWlyZS5yZXNvbHZlKG5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNsaWVudFNjcmlwdE1vZHVsZUVudHJ5UG9pbnRQYXRoQ2FsY3VsYXRpb25FcnJvciwgZS5tZXNzYWdlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGcm9tUGF0aChyZXNvbHZlZFBhdGgpO1xuXG4gICAgICAgIHRoaXMubW9kdWxlID0gbmFtZTtcbiAgICB9XG5cbiAgICBfcHJlcGFyZVVybCAoKSB7XG4gICAgICAgIHRoaXMudXJsID0gdGhpcy51cmwucmVwbGFjZShCRUFVVElGWV9SRUdFWFAsIEJFQVVUSUZZX0NIQVIpLnRvTG93ZXJDYXNlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgbG9hZCAoKSB7XG4gICAgICAgIGlmICh0aGlzLmluaXQgPT09IG51bGwpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNsaWVudFNjcmlwdEluaXRpYWxpemVySXNOb3RTcGVjaWZpZWQpO1xuICAgICAgICBlbHNlIGlmICh0eXBlb2YgdGhpcy5pbml0ID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGcm9tUGF0aCh0aGlzLmluaXQpO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcGF0aDogaW5pdFBhdGgsIGNvbnRlbnQ6IGluaXRDb250ZW50LCBtb2R1bGU6IGluaXRNb2R1bGUsIHBhZ2U6IGluaXRQYWdlIH0gPSB0aGlzLmluaXQ7XG5cbiAgICAgICAgICAgIGlmIChpbml0UGF0aCAmJiBpbml0Q29udGVudCB8fCBpbml0UGF0aCAmJiBpbml0TW9kdWxlIHx8IGluaXRDb250ZW50ICYmIGluaXRNb2R1bGUpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5jbGllbnRTY3JpcHRJbml0aWFsaXplck11bHRpcGxlQ29udGVudFNvdXJjZXMpO1xuXG4gICAgICAgICAgICBpZiAoaW5pdFBhdGgpXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZyb21QYXRoKGluaXRQYXRoKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKGluaXRNb2R1bGUpXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZyb21Nb2R1bGUoaW5pdE1vZHVsZSk7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZW50ID0gaW5pdENvbnRlbnQ7XG5cbiAgICAgICAgICAgIGlmIChpbml0UGFnZSlcbiAgICAgICAgICAgICAgICB0aGlzLnBhZ2UgPSBuZXcgUmVxdWVzdEZpbHRlclJ1bGUoaW5pdFBhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fY2FsY3VsYXRlSGFzaCgpO1xuICAgICAgICB0aGlzLl9wcmVwYXJlVXJsKCk7XG4gICAgfVxuXG4gICAgX2NhbGN1bGF0ZUhhc2ggKCkge1xuICAgICAgICB0aGlzLmhhc2ggPSBjcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUodGhpcy5jb250ZW50KS5kaWdlc3QoKTtcbiAgICB9XG5cbiAgICBfY29udGVudFRvU3RyaW5nICgpIHtcbiAgICAgICAgbGV0IGRpc3BsYXlDb250ZW50ID0gJyc7XG5cbiAgICAgICAgaWYgKHRoaXMuY29udGVudC5sZW5ndGggPD0gQ09OVEVOVF9TVFJfTUFYX0xFTkdUSCAtIENPTlRFTlRfRUxMSVBTSVNfU1RSLmxlbmd0aClcbiAgICAgICAgICAgIGRpc3BsYXlDb250ZW50ID0gdGhpcy5jb250ZW50O1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBkaXNwbGF5Q29udGVudCA9IHRoaXMuY29udGVudC5zdWJzdHJpbmcoMCwgQ09OVEVOVF9TVFJfTUFYX0xFTkdUSCAtIENPTlRFTlRfRUxMSVBTSVNfU1RSLmxlbmd0aCkgKyBDT05URU5UX0VMTElQU0lTX1NUUjtcblxuICAgICAgICByZXR1cm4gYHsgY29udGVudDogJyR7ZGlzcGxheUNvbnRlbnR9JyB9YDtcbiAgICB9XG5cbiAgICB0b1N0cmluZyAoKSB7XG4gICAgICAgIGlmICghdGhpcy5jb250ZW50KVxuICAgICAgICAgICAgcmV0dXJuIEVNUFRZX0NPTlRFTlRfU1RSO1xuXG4gICAgICAgIGVsc2UgaWYgKHRoaXMuY29udGVudCAmJiAhdGhpcy5wYXRoKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRlbnRUb1N0cmluZygpO1xuXG4gICAgICAgIHJldHVybiBgeyBwYXRoOiAnJHt0aGlzLnBhdGh9JyB9YDtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0IFVSTF9VTklRVUVfUEFSVF9MRU5HVEggKCkge1xuICAgICAgICByZXR1cm4gVVJMX1VOSVFVRV9QQVJUX0xFTkdUSDtcbiAgICB9XG59XG4iXX0=