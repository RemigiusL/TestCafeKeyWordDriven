"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const debug_1 = __importDefault(require("debug"));
const path_1 = require("path");
const fs_1 = __importDefault(require("fs"));
const child_process_1 = require("child_process");
const make_dir_1 = __importDefault(require("make-dir"));
const temp_directory_1 = __importDefault(require("../utils/temp-directory"));
const path_pattern_1 = __importDefault(require("../utils/path-pattern"));
const warning_message_1 = __importDefault(require("../notifications/warning-message"));
const string_1 = require("../utils/string");
const test_run_video_recorder_1 = __importDefault(require("./test-run-video-recorder"));
const DEBUG_LOGGER = debug_1.default('testcafe:video-recorder');
const VIDEO_EXTENSION = 'mp4';
const TEMP_DIR_PREFIX = 'video';
class VideoRecorder {
    constructor(browserJob, basePath, opts, encodingOpts, warningLog) {
        this.browserJob = browserJob;
        this.basePath = basePath;
        this.failedOnly = opts.failedOnly;
        this.singleFile = opts.singleFile;
        this.ffmpegPath = opts.ffmpegPath;
        this.customPathPattern = opts.pathPattern;
        this.timeStamp = opts.timeStamp;
        this.encodingOptions = encodingOpts;
        this.warningLog = warningLog;
        this.tempDirectory = new temp_directory_1.default(TEMP_DIR_PREFIX);
        this.firstFile = true;
        this.testRunVideoRecorders = {};
        this._assignEventHandlers(browserJob);
    }
    _createSafeListener(listener) {
        return async (...args) => {
            try {
                return await listener.apply(this, args);
            }
            catch (error) {
                DEBUG_LOGGER(listener && listener.name, error);
                return void 0;
            }
        };
    }
    _assignEventHandlers(browserJob) {
        browserJob.once('start', this._createSafeListener(() => {
            this.tempDirectoryInitializedPromise = this._onBrowserJobStart();
            return this.tempDirectoryInitializedPromise;
        }));
        browserJob.once('done', this._createSafeListener(this._onBrowserJobDone));
        browserJob.on('test-run-create', this._createSafeListener(this._onTestRunCreate));
        browserJob.on('test-run-ready', this._createSafeListener(this._onTestRunReady));
        browserJob.on('test-run-before-done', this._createSafeListener(this._onTestRunBeforeDone));
    }
    _addProblematicPlaceholdersWarning(placeholders) {
        const problematicPlaceholderListStr = string_1.getConcatenatedValuesString(placeholders);
        const suffix = string_1.getPluralSuffix(placeholders);
        const verb = string_1.getToBeInPastTense(placeholders);
        this.warningLog.addWarning(warning_message_1.default.problematicPathPatternPlaceholderForVideoRecording, problematicPlaceholderListStr, suffix, suffix, verb);
    }
    _getTargetVideoPath(testRunRecorder) {
        const data = Object.assign(testRunRecorder.testRunInfo, { now: this.timeStamp });
        if (this.singleFile) {
            data.testIndex = null;
            data.fixture = null;
            data.test = null;
        }
        const pathPattern = new path_pattern_1.default(this.customPathPattern, VIDEO_EXTENSION, data);
        pathPattern.on('problematic-placeholders-found', ({ placeholders }) => this._addProblematicPlaceholdersWarning(placeholders));
        return path_1.join(this.basePath, pathPattern.getPath());
    }
    _concatVideo(targetVideoPath, { tempVideoPath, tempMergeConfigPath, tmpMergeName }) {
        if (this.firstFile) {
            this.firstFile = false;
            return;
        }
        fs_1.default.writeFileSync(tempMergeConfigPath, `
            file '${targetVideoPath}'
            file '${tempVideoPath}'
        `);
        child_process_1.spawnSync(this.ffmpegPath, ['-y', '-f', 'concat', '-safe', '0', '-i', tempMergeConfigPath, '-c', 'copy', tmpMergeName], { stdio: 'ignore' });
        fs_1.default.copyFileSync(tmpMergeName, tempVideoPath);
    }
    async _onBrowserJobStart() {
        await this.tempDirectory.init();
    }
    async _onBrowserJobDone() {
        await this.tempDirectory.dispose();
    }
    async _onTestRunCreate(testRunInfo) {
        if (testRunInfo.legacy)
            return;
        await this.tempDirectoryInitializedPromise;
        const recordingOptions = {
            path: this.tempDirectory.path,
            ffmpegPath: this.ffmpegPath,
            encodingOptions: this.encodingOptions
        };
        const testRunVideoRecorder = this._createTestRunVideoRecorder(testRunInfo, recordingOptions);
        const isVideoSupported = await testRunVideoRecorder.isVideoSupported();
        if (isVideoSupported) {
            await testRunVideoRecorder.init();
            this.testRunVideoRecorders[testRunVideoRecorder.index] = testRunVideoRecorder;
        }
        else
            this.warningLog.addWarning(warning_message_1.default.videoNotSupportedByBrowser, testRunVideoRecorder.testRunInfo.alias);
    }
    _createTestRunVideoRecorder(testRunInfo, recordingOptions) {
        return new test_run_video_recorder_1.default(testRunInfo, recordingOptions, this.warningLog);
    }
    async _onTestRunReady({ index }) {
        const testRunRecorder = this.testRunVideoRecorders[index];
        if (!testRunRecorder)
            return;
        await testRunRecorder.startCapturing();
    }
    async _onTestRunBeforeDone({ index }) {
        const testRunRecorder = this.testRunVideoRecorders[index];
        if (!testRunRecorder)
            return;
        delete this.testRunVideoRecorders[index];
        await testRunRecorder.finishCapturing();
        if (this.failedOnly && !testRunRecorder.hasErrors)
            return;
        await this._saveFiles(testRunRecorder);
    }
    async _saveFiles(testRunRecorder) {
        const videoPath = this._getTargetVideoPath(testRunRecorder);
        await make_dir_1.default(path_1.dirname(videoPath));
        if (this.singleFile)
            this._concatVideo(videoPath, testRunRecorder.tempFiles);
        fs_1.default.copyFileSync(testRunRecorder.tempFiles.tempVideoPath, videoPath);
    }
}
exports.default = VideoRecorder;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdmlkZW8tcmVjb3JkZXIvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxrREFBMEI7QUFDMUIsK0JBQXFDO0FBQ3JDLDRDQUFvQjtBQUNwQixpREFBMEM7QUFDMUMsd0RBQStCO0FBQy9CLDZFQUFvRDtBQUNwRCx5RUFBZ0Q7QUFDaEQsdUZBQWdFO0FBQ2hFLDRDQUFtRztBQUVuRyx3RkFBNkQ7QUFFN0QsTUFBTSxZQUFZLEdBQUcsZUFBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7QUFFdEQsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDO0FBQzlCLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQztBQUVoQyxNQUFxQixhQUFhO0lBQzlCLFlBQWEsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFVBQVU7UUFDN0QsSUFBSSxDQUFDLFVBQVUsR0FBVSxVQUFVLENBQUM7UUFDcEMsSUFBSSxDQUFDLFFBQVEsR0FBWSxRQUFRLENBQUM7UUFDbEMsSUFBSSxDQUFDLFVBQVUsR0FBVSxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxVQUFVLEdBQVUsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUN6QyxJQUFJLENBQUMsVUFBVSxHQUFVLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDekMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUMsSUFBSSxDQUFDLFNBQVMsR0FBVyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxlQUFlLEdBQUssWUFBWSxDQUFDO1FBRXRDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBRTdCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSx3QkFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRXhELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxD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QUVYLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBRSxlQUFlO1FBQzdCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUU1RCxNQUFNLGtCQUFPLENBQUMsY0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFFbEMsSUFBSSxJQUFJLENBQUMsVUFBVTtZQUNmLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1RCxZQUFFLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7Q0FDSjtBQTlKRCxnQ0E4SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHsgam9pbiwgZGlybmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IHNwYXduU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IG1ha2VEaXIgZnJvbSAnbWFrZS1kaXInO1xuaW1wb3J0IFRlbXBEaXJlY3RvcnkgZnJvbSAnLi4vdXRpbHMvdGVtcC1kaXJlY3RvcnknO1xuaW1wb3J0IFBhdGhQYXR0ZXJuIGZyb20gJy4uL3V0aWxzL3BhdGgtcGF0dGVybic7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5pbXBvcnQgeyBnZXRQbHVyYWxTdWZmaXgsIGdldENvbmNhdGVuYXRlZFZhbHVlc1N0cmluZywgZ2V0VG9CZUluUGFzdFRlbnNlIH0gZnJvbSAnLi4vdXRpbHMvc3RyaW5nJztcblxuaW1wb3J0IFRlc3RSdW5WaWRlb1JlY29yZGVyIGZyb20gJy4vdGVzdC1ydW4tdmlkZW8tcmVjb3JkZXInO1xuXG5jb25zdCBERUJVR19MT0dHRVIgPSBkZWJ1ZygndGVzdGNhZmU6dmlkZW8tcmVjb3JkZXInKTtcblxuY29uc3QgVklERU9fRVhURU5TSU9OID0gJ21wNCc7XG5jb25zdCBURU1QX0RJUl9QUkVGSVggPSAndmlkZW8nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWaWRlb1JlY29yZGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoYnJvd3NlckpvYiwgYmFzZVBhdGgsIG9wdHMsIGVuY29kaW5nT3B0cywgd2FybmluZ0xvZykge1xuICAgICAgICB0aGlzLmJyb3dzZXJKb2IgICAgICAgID0gYnJvd3NlckpvYjtcbiAgICAgICAgdGhpcy5iYXNlUGF0aCAgICAgICAgICA9IGJhc2VQYXRoO1xuICAgICAgICB0aGlzLmZhaWxlZE9ubHkgICAgICAgID0gb3B0cy5mYWlsZWRPbmx5O1xuICAgICAgICB0aGlzLnNpbmdsZUZpbGUgICAgICAgID0gb3B0cy5zaW5nbGVGaWxlO1xuICAgICAgICB0aGlzLmZmbXBlZ1BhdGggICAgICAgID0gb3B0cy5mZm1wZWdQYXRoO1xuICAgICAgICB0aGlzLmN1c3RvbVBhdGhQYXR0ZXJuID0gb3B0cy5wYXRoUGF0dGVybjtcbiAgICAgICAgdGhpcy50aW1lU3RhbXAgICAgICAgICA9IG9wdHMudGltZVN0YW1wO1xuICAgICAgICB0aGlzLmVuY29kaW5nT3B0aW9ucyAgID0gZW5jb2RpbmdPcHRzO1xuXG4gICAgICAgIHRoaXMud2FybmluZ0xvZyA9IHdhcm5pbmdMb2c7XG5cbiAgICAgICAgdGhpcy50ZW1wRGlyZWN0b3J5ID0gbmV3IFRlbXBEaXJlY3RvcnkoVEVNUF9ESVJfUFJFRklYKTtcblxuICAgICAgICB0aGlzLmZpcnN0RmlsZSA9IHRydWU7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuVmlkZW9SZWNvcmRlcnMgPSB7fTtcblxuICAgICAgICB0aGlzLl9hc3NpZ25FdmVudEhhbmRsZXJzKGJyb3dzZXJKb2IpO1xuICAgIH1cblxuICAgIF9jcmVhdGVTYWZlTGlzdGVuZXIgKGxpc3RlbmVyKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBERUJVR19MT0dHRVIobGlzdGVuZXIgJiYgbGlzdGVuZXIubmFtZSwgZXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfYXNzaWduRXZlbnRIYW5kbGVycyAoYnJvd3NlckpvYikge1xuICAgICAgICBicm93c2VySm9iLm9uY2UoJ3N0YXJ0JywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudGVtcERpcmVjdG9yeUluaXRpYWxpemVkUHJvbWlzZSA9IHRoaXMuX29uQnJvd3NlckpvYlN0YXJ0KCk7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRlbXBEaXJlY3RvcnlJbml0aWFsaXplZFByb21pc2U7XG4gICAgICAgIH0pKTtcblxuICAgICAgICBicm93c2VySm9iLm9uY2UoJ2RvbmUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25Ccm93c2VySm9iRG9uZSkpO1xuICAgICAgICBicm93c2VySm9iLm9uKCd0ZXN0LXJ1bi1jcmVhdGUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25UZXN0UnVuQ3JlYXRlKSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLXJlYWR5JywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1blJlYWR5KSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLWJlZm9yZS1kb25lJywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1bkJlZm9yZURvbmUpKTtcbiAgICB9XG5cbiAgICBfYWRkUHJvYmxlbWF0aWNQbGFjZWhvbGRlcnNXYXJuaW5nIChwbGFjZWhvbGRlcnMpIHtcbiAgICAgICAgY29uc3QgcHJvYmxlbWF0aWNQbGFjZWhvbGRlckxpc3RTdHIgPSBnZXRDb25jYXRlbmF0ZWRWYWx1ZXNTdHJpbmcocGxhY2Vob2xkZXJzKTtcbiAgICAgICAgY29uc3Qgc3VmZml4ICAgICAgICAgICAgICAgICAgICAgICAgPSBnZXRQbHVyYWxTdWZmaXgocGxhY2Vob2xkZXJzKTtcbiAgICAgICAgY29uc3QgdmVyYiAgICAgICAgICAgICAgICAgICAgICAgICAgPSBnZXRUb0JlSW5QYXN0VGVuc2UocGxhY2Vob2xkZXJzKTtcblxuICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0VTLnByb2JsZW1hdGljUGF0aFBhdHRlcm5QbGFjZWhvbGRlckZvclZpZGVvUmVjb3JkaW5nLCBwcm9ibGVtYXRpY1BsYWNlaG9sZGVyTGlzdFN0ciwgc3VmZml4LCBzdWZmaXgsIHZlcmIpO1xuICAgIH1cblxuICAgIF9nZXRUYXJnZXRWaWRlb1BhdGggKHRlc3RSdW5SZWNvcmRlcikge1xuICAgICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih0ZXN0UnVuUmVjb3JkZXIudGVzdFJ1bkluZm8sIHsgbm93OiB0aGlzLnRpbWVTdGFtcCB9KTtcblxuICAgICAgICBpZiAodGhpcy5zaW5nbGVGaWxlKSB7XG4gICAgICAgICAgICBkYXRhLnRlc3RJbmRleCA9IG51bGw7XG4gICAgICAgICAgICBkYXRhLmZpeHR1cmUgPSBudWxsO1xuICAgICAgICAgICAgZGF0YS50ZXN0ID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhdGhQYXR0ZXJuID0gbmV3IFBhdGhQYXR0ZXJuKHRoaXMuY3VzdG9tUGF0aFBhdHRlcm4sIFZJREVPX0VYVEVOU0lPTiwgZGF0YSk7XG5cbiAgICAgICAgcGF0aFBhdHRlcm4ub24oJ3Byb2JsZW1hdGljLXBsYWNlaG9sZGVycy1mb3VuZCcsICh7IHBsYWNlaG9sZGVycyB9KSA9PiB0aGlzLl9hZGRQcm9ibGVtYXRpY1BsYWNlaG9sZGVyc1dhcm5pbmcocGxhY2Vob2xkZXJzKSk7XG5cbiAgICAgICAgcmV0dXJuIGpvaW4odGhpcy5iYXNlUGF0aCwgcGF0aFBhdHRlcm4uZ2V0UGF0aCgpKTtcbiAgICB9XG5cbiAgICBfY29uY2F0VmlkZW8gKHRhcmdldFZpZGVvUGF0aCwgeyB0ZW1wVmlkZW9QYXRoLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCB0bXBNZXJnZU5hbWUgfSkge1xuICAgICAgICBpZiAodGhpcy5maXJzdEZpbGUpIHtcbiAgICAgICAgICAgIHRoaXMuZmlyc3RGaWxlID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRlbXBNZXJnZUNvbmZpZ1BhdGgsIGBcbiAgICAgICAgICAgIGZpbGUgJyR7dGFyZ2V0VmlkZW9QYXRofSdcbiAgICAgICAgICAgIGZpbGUgJyR7dGVtcFZpZGVvUGF0aH0nXG4gICAgICAgIGApO1xuXG4gICAgICAgIHNwYXduU3luYyh0aGlzLmZmbXBlZ1BhdGgsIFsnLXknLCAnLWYnLCAnY29uY2F0JywgJy1zYWZlJywgJzAnLCAnLWknLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCAnLWMnLCAnY29weScsIHRtcE1lcmdlTmFtZV0sIHsgc3RkaW86ICdpZ25vcmUnIH0pO1xuICAgICAgICBmcy5jb3B5RmlsZVN5bmModG1wTWVyZ2VOYW1lLCB0ZW1wVmlkZW9QYXRoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25Ccm93c2VySm9iU3RhcnQgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLnRlbXBEaXJlY3RvcnkuaW5pdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vbkJyb3dzZXJKb2JEb25lICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy50ZW1wRGlyZWN0b3J5LmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQ3JlYXRlICh0ZXN0UnVuSW5mbykge1xuICAgICAgICBpZiAodGVzdFJ1bkluZm8ubGVnYWN5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRoaXMudGVtcERpcmVjdG9yeUluaXRpYWxpemVkUHJvbWlzZTtcblxuICAgICAgICBjb25zdCByZWNvcmRpbmdPcHRpb25zID0ge1xuICAgICAgICAgICAgcGF0aDogICAgICAgICAgICB0aGlzLnRlbXBEaXJlY3RvcnkucGF0aCxcbiAgICAgICAgICAgIGZmbXBlZ1BhdGg6ICAgICAgdGhpcy5mZm1wZWdQYXRoLFxuICAgICAgICAgICAgZW5jb2RpbmdPcHRpb25zOiB0aGlzLmVuY29kaW5nT3B0aW9uc1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHRlc3RSdW5WaWRlb1JlY29yZGVyID0gdGhpcy5fY3JlYXRlVGVzdFJ1blZpZGVvUmVjb3JkZXIodGVzdFJ1bkluZm8sIHJlY29yZGluZ09wdGlvbnMpO1xuICAgICAgICBjb25zdCBpc1ZpZGVvU3VwcG9ydGVkICAgICA9IGF3YWl0IHRlc3RSdW5WaWRlb1JlY29yZGVyLmlzVmlkZW9TdXBwb3J0ZWQoKTtcblxuICAgICAgICBpZiAoaXNWaWRlb1N1cHBvcnRlZCkge1xuICAgICAgICAgICAgYXdhaXQgdGVzdFJ1blZpZGVvUmVjb3JkZXIuaW5pdCgpO1xuXG4gICAgICAgICAgICB0aGlzLnRlc3RSdW5WaWRlb1JlY29yZGVyc1t0ZXN0UnVuVmlkZW9SZWNvcmRlci5pbmRleF0gPSB0ZXN0UnVuVmlkZW9SZWNvcmRlcjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0VTLnZpZGVvTm90U3VwcG9ydGVkQnlCcm93c2VyLCB0ZXN0UnVuVmlkZW9SZWNvcmRlci50ZXN0UnVuSW5mby5hbGlhcyk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVRlc3RSdW5WaWRlb1JlY29yZGVyICh0ZXN0UnVuSW5mbywgcmVjb3JkaW5nT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gbmV3IFRlc3RSdW5WaWRlb1JlY29yZGVyKHRlc3RSdW5JbmZvLCByZWNvcmRpbmdPcHRpb25zLCB0aGlzLndhcm5pbmdMb2cpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5SZWFkeSAoeyBpbmRleCB9KSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW5SZWNvcmRlciA9IHRoaXMudGVzdFJ1blZpZGVvUmVjb3JkZXJzW2luZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5SZWNvcmRlcilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhd2FpdCB0ZXN0UnVuUmVjb3JkZXIuc3RhcnRDYXB0dXJpbmcoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQmVmb3JlRG9uZSAoeyBpbmRleCB9KSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW5SZWNvcmRlciA9IHRoaXMudGVzdFJ1blZpZGVvUmVjb3JkZXJzW2luZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5SZWNvcmRlcilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBkZWxldGUgdGhpcy50ZXN0UnVuVmlkZW9SZWNvcmRlcnNbaW5kZXhdO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5SZWNvcmRlci5maW5pc2hDYXB0dXJpbmcoKTtcblxuICAgICAgICBpZiAodGhpcy5mYWlsZWRPbmx5ICYmICF0ZXN0UnVuUmVjb3JkZXIuaGFzRXJyb3JzKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX3NhdmVGaWxlcyh0ZXN0UnVuUmVjb3JkZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIF9zYXZlRmlsZXMgKHRlc3RSdW5SZWNvcmRlcikge1xuICAgICAgICBjb25zdCB2aWRlb1BhdGggPSB0aGlzLl9nZXRUYXJnZXRWaWRlb1BhdGgodGVzdFJ1blJlY29yZGVyKTtcblxuICAgICAgICBhd2FpdCBtYWtlRGlyKGRpcm5hbWUodmlkZW9QYXRoKSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2luZ2xlRmlsZSlcbiAgICAgICAgICAgIHRoaXMuX2NvbmNhdFZpZGVvKHZpZGVvUGF0aCwgdGVzdFJ1blJlY29yZGVyLnRlbXBGaWxlcyk7XG5cbiAgICAgICAgZnMuY29weUZpbGVTeW5jKHRlc3RSdW5SZWNvcmRlci50ZW1wRmlsZXMudGVtcFZpZGVvUGF0aCwgdmlkZW9QYXRoKTtcbiAgICB9XG59XG4iXX0=