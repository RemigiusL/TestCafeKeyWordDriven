"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const typescript_1 = __importDefault(require("typescript"));
const lodash_1 = require("lodash");
const test_file_parser_base_1 = require("../../test-file-parser-base");
const typescript_configuration_1 = __importDefault(require("../../../../configuration/typescript-configuration"));
function replaceComments(code) {
    return code.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm, match => {
        const lastSymbol = match.indexOf('\n') > -1 ? '\n' : ' ';
        return lodash_1.repeat(' ', match.length + lastSymbol);
    });
}
class TypeScriptTestFileParser extends test_file_parser_base_1.TestFileParserBase {
    constructor() {
        super(typescript_1.default.SyntaxKind);
    }
    getComputedNameString({ pos, end }) {
        const templatePos = this.getLocationByOffsets(pos, end);
        return test_file_parser_base_1.TestFileParserBase.formatComputedName(templatePos.loc.start.line);
    }
    getTokenType(token) {
        return token.kind;
    }
    getCalleeToken(token) {
        return token.expression;
    }
    getMemberFnName(token) {
        return token.expression.name.text;
    }
    getKeyValue(prop) {
        const { name, initializer } = prop;
        return {
            key: name.text,
            value: this.getStringValue(initializer)
        };
    }
    getFixedStartOffset(start) {
        let fixedStartOffset = start;
        while (/\s/.test(this.codeWithoutComments[fixedStartOffset]))
            ++fixedStartOffset;
        return fixedStartOffset;
    }
    getLocationByOffsets(start, end) {
        const fixedStart = this.getFixedStartOffset(start);
        const codeArr = this.codeArr;
        const loc = { start: null, end: null };
        let line = codeArr[0];
        let startTmp = fixedStart;
        let endTmp = end;
        for (let lineNumber = 1; lineNumber <= codeArr.length; ++lineNumber, line = codeArr[lineNumber - 1]) {
            startTmp -= line.length + 1;
            endTmp -= line.length + 1;
            if (startTmp < 0 && !loc.start)
                loc.start = { line: lineNumber, column: line.length + startTmp + 1 };
            if (endTmp <= 0 || lineNumber === codeArr.length - 1) {
                loc.end = { line: lineNumber, column: line.length + endTmp + 1 };
                break;
            }
        }
        return { loc, start: fixedStart, end };
    }
    getRValue(token) {
        return token.declarationList.declarations[0].initializer;
    }
    getStringValue(token) {
        const stringTypes = [this.tokenType.StringLiteral, this.tokenType.TemplateExpression];
        if (stringTypes.indexOf(token.kind) > -1 || token.text && token.kind !== this.tokenType.NumericLiteral)
            return this.formatFnArg(token);
        return null;
    }
    isAsyncFn(token) {
        const isGeneratorFn = !!token.asteriskToken;
        const isAsyncFn = token.modifiers &&
            token.modifiers.some(modifier => modifier.kind === this.tokenType.AsyncKeyword);
        return isGeneratorFn || isAsyncFn;
    }
    getFunctionBody(token) {
        return token.body.statements;
    }
    formatFnData(name, value, token, meta = [{}]) {
        const loc = this.getLocationByOffsets(token.pos, token.end);
        return {
            fnName: name,
            value: value,
            loc: loc.loc,
            start: loc.start,
            end: loc.end,
            meta: lodash_1.merge({}, ...meta)
        };
    }
    analyzeMemberExp(token) {
        let exp = token;
        const tokenType = this.tokenType;
        const callStack = [exp];
        while (exp.kind !== this.tokenType.Identifier) {
            exp = exp.expression || exp.tag;
            callStack.push(exp);
        }
        const meta = this.getMetaInfo(callStack.slice());
        if (exp && this.isApiFn(exp.text)) {
            let parentExp = callStack.pop();
            while (parentExp) {
                if (parentExp.kind === tokenType.CallExpression && parentExp.expression) {
                    const calleeType = parentExp.expression.kind;
                    const calleeMemberFn = calleeType === tokenType.PropertyAccessExpression &&
                        parentExp.expression.name.text;
                    if (this.checkExpDefineTargetName(calleeType, calleeMemberFn))
                        return this.formatFnData(exp.text, this.formatFnArg(parentExp.arguments[0]), token, meta);
                }
                if (parentExp.kind === tokenType.TaggedTemplateExpression && parentExp.tag) {
                    const tagType = parentExp.tag.kind;
                    const tagMemberFn = tagType === tokenType.PropertyAccessExpression && parentExp.tag.name.text;
                    if (this.checkExpDefineTargetName(tagType, tagMemberFn))
                        return this.formatFnData(exp.text, this.formatFnArg(parentExp), token, meta);
                }
                parentExp = callStack.pop();
            }
        }
        return null;
    }
    formatFnArg(arg) {
        if (arg.templateSpans)
            return this.getComputedNameString({ pos: arg.pos, end: arg.end });
        if (arg.head)
            return this.getComputedNameString({ pos: arg.template.pos, end: arg.template.end });
        if (arg.template)
            return arg.template.text || this.getComputedNameString({ pos: arg.template.pos, end: arg.template.end });
        if (arg.kind === this.tokenType.Identifier)
            return this.getComputedNameString({ pos: arg.pos, end: arg.end });
        if (arg.text && arg.kind !== this.tokenType.NumericLiteral)
            return arg.text;
        if (arg.kind === this.tokenType.TypeAssertionExpression)
            return this.formatFnArg(arg.expression);
        return null;
    }
    getFnCall(token) {
        if (this.isApiFn(token.expression.text))
            return this.formatFnData(token.expression.text, this.formatFnArg(token.arguments[0]), token);
        return null;
    }
    getTaggedTemplateExp(token) {
        if (this.isApiFn(token.tag.text))
            return this.formatFnData(token.tag.text, this.formatFnArg(token), token);
        return null;
    }
    analyzeFnCall(token) {
        const tokenType = this.tokenType;
        if (token.kind === tokenType.PropertyAccessExpression)
            return this.analyzeMemberExp(token);
        if (token.kind === tokenType.CallExpression) {
            const expKind = token.expression.kind;
            if (expKind === tokenType.PropertyAccessExpression || expKind === tokenType.CallExpression)
                return this.analyzeMemberExp(token);
            if (expKind === tokenType.ParenthesizedExpression)
                return this.analyzeFnCall(token.expression.expression);
            return this.getFnCall(token);
        }
        if (token.kind === tokenType.FunctionExpression || token.kind === tokenType.ArrowFunction)
            return this.collectTestCafeCalls(this.getFunctionBody(token));
        if (token.kind === tokenType.TaggedTemplateExpression) {
            if (token.tag.kind === tokenType.PropertyAccessExpression || token.tag.kind === tokenType.CallExpression)
                return this.analyzeMemberExp(token);
            return this.getTaggedTemplateExp(token);
        }
        return null;
    }
    parse(code) {
        //NOTE: TypeScript calculates start position of a token incorrectly
        //It doesn't consider spaces and comments between the last token and the current token.
        //So we replace comments with space symbols to calculate fixed position.
        //We just increment position until we meet non whitespace characters
        this.codeArr = code.split('\n');
        this.codeWithoutComments = replaceComments(code);
        const tsConfig = new typescript_configuration_1.default();
        const sourceFile = typescript_1.default.createSourceFile('', code, tsConfig.getOptions(), true);
        return this.analyze(sourceFile.statements);
    }
}
const parser = new TypeScriptTestFileParser();
exports.getTypeScriptTestList = parser.getTestList.bind(parser);
exports.getTypeScriptTestListFromCode = parser.getTestListFromCode.bind(parser);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXRlc3QtbGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy90eXBlc2NyaXB0L2dldC10ZXN0LWxpc3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw0REFBNEI7QUFDNUIsbUNBQXVDO0FBQ3ZDLHVFQUFpRTtBQUNqRSxrSEFBeUY7QUFFekYsU0FBUyxlQUFlLENBQUUsSUFBSTtJQUMxQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsc0NBQXNDLEVBQUUsS0FBSyxDQUFDLEVBQUU7UUFDaEUsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFFekQsT0FBTyxlQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsTUFBTSx3QkFBeUIsU0FBUSwwQ0FBa0I7SUFDckQ7UUFDSSxLQUFLLENBQUMsb0JBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQscUJBQXFCLENBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO1FBQy9CLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFeEQsT0FBTywwQ0FBa0IsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBRUQsWUFBWSxDQUFFLEtBQUs7UUFDZixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDdEIsQ0FBQztJQUVELGNBQWMsQ0FBRSxLQUFLO1FBQ2pCLE9BQU8sS0FBSyxD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QUNoQixDQUFDO0lBRUQsS0FBSyxDQUFFLElBQUk7UUFDUCxtRUFBbUU7UUFDbkUsdUZBQXVGO1FBQ3ZGLHdFQUF3RTtRQUN4RSxvRUFBb0U7UUFDcEUsSUFBSSxDQUFDLE9BQU8sR0FBZSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakQsTUFBTSxRQUFRLEdBQUssSUFBSSxrQ0FBdUIsRUFBRSxDQUFDO1FBQ2pELE1BQU0sVUFBVSxHQUFHLG9CQUFFLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFOUUsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMvQyxDQUFDO0NBQ0o7QUFFRCxNQUFNLE1BQU0sR0FBRyxJQUFJLHdCQUF3QixFQUFFLENBQUM7QUFFakMsUUFBQSxxQkFBcUIsR0FBVyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNoRSxRQUFBLDZCQUE2QixHQUFHLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgeyByZXBlYXQsIG1lcmdlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFRlc3RGaWxlUGFyc2VyQmFzZSB9IGZyb20gJy4uLy4uL3Rlc3QtZmlsZS1wYXJzZXItYmFzZSc7XG5pbXBvcnQgVHlwZXNjcmlwdENvbmZpZ3VyYXRpb24gZnJvbSAnLi4vLi4vLi4vLi4vY29uZmlndXJhdGlvbi90eXBlc2NyaXB0LWNvbmZpZ3VyYXRpb24nO1xuXG5mdW5jdGlvbiByZXBsYWNlQ29tbWVudHMgKGNvZGUpIHtcbiAgICByZXR1cm4gY29kZS5yZXBsYWNlKC9cXC9cXCpbXFxzXFxTXSo/XFwqXFwvfChbXlxcXFw6XXxeKVxcL1xcLy4qJC9nbSwgbWF0Y2ggPT4ge1xuICAgICAgICBjb25zdCBsYXN0U3ltYm9sID0gbWF0Y2guaW5kZXhPZignXFxuJykgPiAtMSA/ICdcXG4nIDogJyAnO1xuXG4gICAgICAgIHJldHVybiByZXBlYXQoJyAnLCBtYXRjaC5sZW5ndGggKyBsYXN0U3ltYm9sKTtcbiAgICB9KTtcbn1cblxuY2xhc3MgVHlwZVNjcmlwdFRlc3RGaWxlUGFyc2VyIGV4dGVuZHMgVGVzdEZpbGVQYXJzZXJCYXNlIHtcbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHN1cGVyKHRzLlN5bnRheEtpbmQpO1xuICAgIH1cblxuICAgIGdldENvbXB1dGVkTmFtZVN0cmluZyAoeyBwb3MsIGVuZCB9KSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlUG9zID0gdGhpcy5nZXRMb2NhdGlvbkJ5T2Zmc2V0cyhwb3MsIGVuZCk7XG5cbiAgICAgICAgcmV0dXJuIFRlc3RGaWxlUGFyc2VyQmFzZS5mb3JtYXRDb21wdXRlZE5hbWUodGVtcGxhdGVQb3MubG9jLnN0YXJ0LmxpbmUpO1xuICAgIH1cblxuICAgIGdldFRva2VuVHlwZSAodG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuLmtpbmQ7XG4gICAgfVxuXG4gICAgZ2V0Q2FsbGVlVG9rZW4gKHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbi5leHByZXNzaW9uO1xuICAgIH1cblxuICAgIGdldE1lbWJlckZuTmFtZSAodG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuLmV4cHJlc3Npb24ubmFtZS50ZXh0O1xuICAgIH1cblxuICAgIGdldEtleVZhbHVlIChwcm9wKSB7XG4gICAgICAgIGNvbnN0IHsgbmFtZSwgaW5pdGlhbGl6ZXIgfSA9IHByb3A7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtleTogICBuYW1lLnRleHQsXG4gICAgICAgICAgICB2YWx1ZTogdGhpcy5nZXRTdHJpbmdWYWx1ZShpbml0aWFsaXplcilcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRGaXhlZFN0YXJ0T2Zmc2V0IChzdGFydCkge1xuICAgICAgICBsZXQgZml4ZWRTdGFydE9mZnNldCA9IHN0YXJ0O1xuXG4gICAgICAgIHdoaWxlICgvXFxzLy50ZXN0KHRoaXMuY29kZVdpdGhvdXRDb21tZW50c1tmaXhlZFN0YXJ0T2Zmc2V0XSkpXG4gICAgICAgICAgICArK2ZpeGVkU3RhcnRPZmZzZXQ7XG5cbiAgICAgICAgcmV0dXJuIGZpeGVkU3RhcnRPZmZzZXQ7XG4gICAgfVxuXG4gICAgZ2V0TG9jYXRpb25CeU9mZnNldHMgKHN0YXJ0LCBlbmQpIHtcbiAgICAgICAgY29uc3QgZml4ZWRTdGFydCA9IHRoaXMuZ2V0Rml4ZWRTdGFydE9mZnNldChzdGFydCk7XG4gICAgICAgIGNvbnN0IGNvZGVBcnIgICAgPSB0aGlzLmNvZGVBcnI7XG4gICAgICAgIGNvbnN0IGxvYyAgICAgICAgPSB7IHN0YXJ0OiBudWxsLCBlbmQ6IG51bGwgfTtcblxuICAgICAgICBsZXQgbGluZSAgICAgPSBjb2RlQXJyWzBdO1xuICAgICAgICBsZXQgc3RhcnRUbXAgPSBmaXhlZFN0YXJ0O1xuICAgICAgICBsZXQgZW5kVG1wICAgPSBlbmQ7XG5cbiAgICAgICAgZm9yIChsZXQgbGluZU51bWJlciA9IDE7IGxpbmVOdW1iZXIgPD0gY29kZUFyci5sZW5ndGg7ICsrbGluZU51bWJlciwgbGluZSA9IGNvZGVBcnJbbGluZU51bWJlciAtIDFdKSB7XG4gICAgICAgICAgICBzdGFydFRtcCAtPSBsaW5lLmxlbmd0aCArIDE7XG4gICAgICAgICAgICBlbmRUbXAgLT0gbGluZS5sZW5ndGggKyAxO1xuXG4gICAgICAgICAgICBpZiAoc3RhcnRUbXAgPCAwICYmICFsb2Muc3RhcnQpXG4gICAgICAgICAgICAgICAgbG9jLnN0YXJ0ID0geyBsaW5lOiBsaW5lTnVtYmVyLCBjb2x1bW46IGxpbmUubGVuZ3RoICsgc3RhcnRUbXAgKyAxIH07XG5cbiAgICAgICAgICAgIGlmIChlbmRUbXAgPD0gMCB8fCBsaW5lTnVtYmVyID09PSBjb2RlQXJyLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBsb2MuZW5kID0geyBsaW5lOiBsaW5lTnVtYmVyLCBjb2x1bW46IGxpbmUubGVuZ3RoICsgZW5kVG1wICsgMSB9O1xuXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBsb2MsIHN0YXJ0OiBmaXhlZFN0YXJ0LCBlbmQgfTtcbiAgICB9XG5cbiAgICBnZXRSVmFsdWUgKHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbi5kZWNsYXJhdGlvbkxpc3QuZGVjbGFyYXRpb25zWzBdLmluaXRpYWxpemVyO1xuICAgIH1cblxuICAgIGdldFN0cmluZ1ZhbHVlICh0b2tlbikge1xuICAgICAgICBjb25zdCBzdHJpbmdUeXBlcyA9IFt0aGlzLnRva2VuVHlwZS5TdHJpbmdMaXRlcmFsLCB0aGlzLnRva2VuVHlwZS5UZW1wbGF0ZUV4cHJlc3Npb25dO1xuXG4gICAgICAgIGlmIChzdHJpbmdUeXBlcy5pbmRleE9mKHRva2VuLmtpbmQpID4gLTEgfHwgdG9rZW4udGV4dCAmJiB0b2tlbi5raW5kICE9PSB0aGlzLnRva2VuVHlwZS5OdW1lcmljTGl0ZXJhbClcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuQXJnKHRva2VuKTtcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBpc0FzeW5jRm4gKHRva2VuKSB7XG4gICAgICAgIGNvbnN0IGlzR2VuZXJhdG9yRm4gPSAhIXRva2VuLmFzdGVyaXNrVG9rZW47XG4gICAgICAgIGNvbnN0IGlzQXN5bmNGbiAgICAgPSB0b2tlbi5tb2RpZmllcnMgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLm1vZGlmaWVycy5zb21lKG1vZGlmaWVyID0+IG1vZGlmaWVyLmtpbmQgPT09IHRoaXMudG9rZW5UeXBlLkFzeW5jS2V5d29yZCk7XG5cbiAgICAgICAgcmV0dXJuIGlzR2VuZXJhdG9yRm4gfHwgaXNBc3luY0ZuO1xuICAgIH1cblxuICAgIGdldEZ1bmN0aW9uQm9keSAodG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuLmJvZHkuc3RhdGVtZW50cztcbiAgICB9XG5cbiAgICBmb3JtYXRGbkRhdGEgKG5hbWUsIHZhbHVlLCB0b2tlbiwgbWV0YSA9IFt7fV0pIHtcbiAgICAgICAgY29uc3QgbG9jID0gdGhpcy5nZXRMb2NhdGlvbkJ5T2Zmc2V0cyh0b2tlbi5wb3MsIHRva2VuLmVuZCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZuTmFtZTogbmFtZSxcbiAgICAgICAgICAgIHZhbHVlOiAgdmFsdWUsXG4gICAgICAgICAgICBsb2M6ICAgIGxvYy5sb2MsXG4gICAgICAgICAgICBzdGFydDogIGxvYy5zdGFydCxcbiAgICAgICAgICAgIGVuZDogICAgbG9jLmVuZCxcbiAgICAgICAgICAgIG1ldGE6ICAgbWVyZ2Uoe30sIC4uLm1ldGEpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYW5hbHl6ZU1lbWJlckV4cCAodG9rZW4pIHtcbiAgICAgICAgbGV0IGV4cCAgICAgICAgID0gdG9rZW47XG4gICAgICAgIGNvbnN0IHRva2VuVHlwZSA9IHRoaXMudG9rZW5UeXBlO1xuICAgICAgICBjb25zdCBjYWxsU3RhY2sgPSBbZXhwXTtcblxuICAgICAgICB3aGlsZSAoZXhwLmtpbmQgIT09IHRoaXMudG9rZW5UeXBlLklkZW50aWZpZXIpIHtcbiAgICAgICAgICAgIGV4cCA9IGV4cC5leHByZXNzaW9uIHx8IGV4cC50YWc7XG5cbiAgICAgICAgICAgIGNhbGxTdGFjay5wdXNoKGV4cCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtZXRhID0gdGhpcy5nZXRNZXRhSW5mbyhjYWxsU3RhY2suc2xpY2UoKSk7XG5cbiAgICAgICAgaWYgKGV4cCAmJiB0aGlzLmlzQXBpRm4oZXhwLnRleHQpKSB7XG4gICAgICAgICAgICBsZXQgcGFyZW50RXhwID0gY2FsbFN0YWNrLnBvcCgpO1xuXG4gICAgICAgICAgICB3aGlsZSAocGFyZW50RXhwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudEV4cC5raW5kID09PSB0b2tlblR5cGUuQ2FsbEV4cHJlc3Npb24gJiYgcGFyZW50RXhwLmV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbGVlVHlwZSAgICAgPSBwYXJlbnRFeHAuZXhwcmVzc2lvbi5raW5kO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWxsZWVNZW1iZXJGbiA9IGNhbGxlZVR5cGUgPT09IHRva2VuVHlwZS5Qcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24gJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRFeHAuZXhwcmVzc2lvbi5uYW1lLnRleHQ7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tFeHBEZWZpbmVUYXJnZXROYW1lKGNhbGxlZVR5cGUsIGNhbGxlZU1lbWJlckZuKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuRGF0YShleHAudGV4dCwgdGhpcy5mb3JtYXRGbkFyZyhwYXJlbnRFeHAuYXJndW1lbnRzWzBdKSwgdG9rZW4sIG1ldGEpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChwYXJlbnRFeHAua2luZCA9PT0gdG9rZW5UeXBlLlRhZ2dlZFRlbXBsYXRlRXhwcmVzc2lvbiAmJiBwYXJlbnRFeHAudGFnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhZ1R5cGUgICAgID0gcGFyZW50RXhwLnRhZy5raW5kO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWdNZW1iZXJGbiA9IHRhZ1R5cGUgPT09IHRva2VuVHlwZS5Qcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24gJiYgcGFyZW50RXhwLnRhZy5uYW1lLnRleHQ7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tFeHBEZWZpbmVUYXJnZXROYW1lKHRhZ1R5cGUsIHRhZ01lbWJlckZuKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEZuRGF0YShleHAudGV4dCwgdGhpcy5mb3JtYXRGbkFyZyhwYXJlbnRFeHApLCB0b2tlbiwgbWV0YSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcGFyZW50RXhwID0gY2FsbFN0YWNrLnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZm9ybWF0Rm5BcmcgKGFyZykge1xuICAgICAgICBpZiAoYXJnLnRlbXBsYXRlU3BhbnMpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb21wdXRlZE5hbWVTdHJpbmcoeyBwb3M6IGFyZy5wb3MsIGVuZDogYXJnLmVuZCB9KTtcblxuICAgICAgICBpZiAoYXJnLmhlYWQpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb21wdXRlZE5hbWVTdHJpbmcoeyBwb3M6IGFyZy50ZW1wbGF0ZS5wb3MsIGVuZDogYXJnLnRlbXBsYXRlLmVuZCB9KTtcblxuICAgICAgICBpZiAoYXJnLnRlbXBsYXRlKVxuICAgICAgICAgICAgcmV0dXJuIGFyZy50ZW1wbGF0ZS50ZXh0IHx8IHRoaXMuZ2V0Q29tcHV0ZWROYW1lU3RyaW5nKHsgcG9zOiBhcmcudGVtcGxhdGUucG9zLCBlbmQ6IGFyZy50ZW1wbGF0ZS5lbmQgfSk7XG5cbiAgICAgICAgaWYgKGFyZy5raW5kID09PSB0aGlzLnRva2VuVHlwZS5JZGVudGlmaWVyKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29tcHV0ZWROYW1lU3RyaW5nKHsgcG9zOiBhcmcucG9zLCBlbmQ6IGFyZy5lbmQgfSk7XG5cbiAgICAgICAgaWYgKGFyZy50ZXh0ICYmIGFyZy5raW5kICE9PSB0aGlzLnRva2VuVHlwZS5OdW1lcmljTGl0ZXJhbClcbiAgICAgICAgICAgIHJldHVybiBhcmcudGV4dDtcblxuICAgICAgICBpZiAoYXJnLmtpbmQgPT09IHRoaXMudG9rZW5UeXBlLlR5cGVBc3NlcnRpb25FeHByZXNzaW9uKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0Rm5BcmcoYXJnLmV4cHJlc3Npb24pO1xuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGdldEZuQ2FsbCAodG9rZW4pIHtcbiAgICAgICAgaWYgKHRoaXMuaXNBcGlGbih0b2tlbi5leHByZXNzaW9uLnRleHQpKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0Rm5EYXRhKHRva2VuLmV4cHJlc3Npb24udGV4dCwgdGhpcy5mb3JtYXRGbkFyZyh0b2tlbi5hcmd1bWVudHNbMF0pLCB0b2tlbik7XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZ2V0VGFnZ2VkVGVtcGxhdGVFeHAgKHRva2VuKSB7XG4gICAgICAgIGlmICh0aGlzLmlzQXBpRm4odG9rZW4udGFnLnRleHQpKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0Rm5EYXRhKHRva2VuLnRhZy50ZXh0LCB0aGlzLmZvcm1hdEZuQXJnKHRva2VuKSwgdG9rZW4pO1xuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGFuYWx5emVGbkNhbGwgKHRva2VuKSB7XG4gICAgICAgIGNvbnN0IHRva2VuVHlwZSA9IHRoaXMudG9rZW5UeXBlO1xuXG4gICAgICAgIGlmICh0b2tlbi5raW5kID09PSB0b2tlblR5cGUuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5hbHl6ZU1lbWJlckV4cCh0b2tlbik7XG5cbiAgICAgICAgaWYgKHRva2VuLmtpbmQgPT09IHRva2VuVHlwZS5DYWxsRXhwcmVzc2lvbikge1xuICAgICAgICAgICAgY29uc3QgZXhwS2luZCA9IHRva2VuLmV4cHJlc3Npb24ua2luZDtcblxuICAgICAgICAgICAgaWYgKGV4cEtpbmQgPT09IHRva2VuVHlwZS5Qcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24gfHwgZXhwS2luZCA9PT0gdG9rZW5UeXBlLkNhbGxFeHByZXNzaW9uKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVNZW1iZXJFeHAodG9rZW4pO1xuXG4gICAgICAgICAgICBpZiAoZXhwS2luZCA9PT0gdG9rZW5UeXBlLlBhcmVudGhlc2l6ZWRFeHByZXNzaW9uKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVGbkNhbGwodG9rZW4uZXhwcmVzc2lvbi5leHByZXNzaW9uKTtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm5DYWxsKHRva2VuKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0b2tlbi5raW5kID09PSB0b2tlblR5cGUuRnVuY3Rpb25FeHByZXNzaW9uIHx8IHRva2VuLmtpbmQgPT09IHRva2VuVHlwZS5BcnJvd0Z1bmN0aW9uKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29sbGVjdFRlc3RDYWZlQ2FsbHModGhpcy5nZXRGdW5jdGlvbkJvZHkodG9rZW4pKTtcblxuICAgICAgICBpZiAodG9rZW4ua2luZCA9PT0gdG9rZW5UeXBlLlRhZ2dlZFRlbXBsYXRlRXhwcmVzc2lvbikge1xuICAgICAgICAgICAgaWYgKHRva2VuLnRhZy5raW5kID09PSB0b2tlblR5cGUuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uIHx8IHRva2VuLnRhZy5raW5kID09PSB0b2tlblR5cGUuQ2FsbEV4cHJlc3Npb24pXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5hbHl6ZU1lbWJlckV4cCh0b2tlbik7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFRhZ2dlZFRlbXBsYXRlRXhwKHRva2VuKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHBhcnNlIChjb2RlKSB7XG4gICAgICAgIC8vTk9URTogVHlwZVNjcmlwdCBjYWxjdWxhdGVzIHN0YXJ0IHBvc2l0aW9uIG9mIGEgdG9rZW4gaW5jb3JyZWN0bHlcbiAgICAgICAgLy9JdCBkb2Vzbid0IGNvbnNpZGVyIHNwYWNlcyBhbmQgY29tbWVudHMgYmV0d2VlbiB0aGUgbGFzdCB0b2tlbiBhbmQgdGhlIGN1cnJlbnQgdG9rZW4uXG4gICAgICAgIC8vU28gd2UgcmVwbGFjZSBjb21tZW50cyB3aXRoIHNwYWNlIHN5bWJvbHMgdG8gY2FsY3VsYXRlIGZpeGVkIHBvc2l0aW9uLlxuICAgICAgICAvL1dlIGp1c3QgaW5jcmVtZW50IHBvc2l0aW9uIHVudGlsIHdlIG1lZXQgbm9uIHdoaXRlc3BhY2UgY2hhcmFjdGVyc1xuICAgICAgICB0aGlzLmNvZGVBcnIgICAgICAgICAgICAgPSBjb2RlLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgdGhpcy5jb2RlV2l0aG91dENvbW1lbnRzID0gcmVwbGFjZUNvbW1lbnRzKGNvZGUpO1xuXG4gICAgICAgIGNvbnN0IHRzQ29uZmlnICAgPSBuZXcgVHlwZXNjcmlwdENvbmZpZ3VyYXRpb24oKTtcbiAgICAgICAgY29uc3Qgc291cmNlRmlsZSA9IHRzLmNyZWF0ZVNvdXJjZUZpbGUoJycsIGNvZGUsIHRzQ29uZmlnLmdldE9wdGlvbnMoKSwgdHJ1ZSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuYW5hbHl6ZShzb3VyY2VGaWxlLnN0YXRlbWVudHMpO1xuICAgIH1cbn1cblxuY29uc3QgcGFyc2VyID0gbmV3IFR5cGVTY3JpcHRUZXN0RmlsZVBhcnNlcigpO1xuXG5leHBvcnQgY29uc3QgZ2V0VHlwZVNjcmlwdFRlc3RMaXN0ICAgICAgICAgPSBwYXJzZXIuZ2V0VGVzdExpc3QuYmluZChwYXJzZXIpO1xuZXhwb3J0IGNvbnN0IGdldFR5cGVTY3JpcHRUZXN0TGlzdEZyb21Db2RlID0gcGFyc2VyLmdldFRlc3RMaXN0RnJvbUNvZGUuYmluZChwYXJzZXIpO1xuIl19