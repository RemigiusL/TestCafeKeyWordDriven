"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = __importDefault(require("events"));
const lodash_1 = __importDefault(require("lodash"));
const test_run_1 = require("./test-run");
const test_run_state_1 = __importDefault(require("./test-run-state"));
class LiveModeTestRunController extends events_1.default {
    constructor() {
        super();
        this.testWrappers = [];
        this.expectedTestCount = 0;
        this._testRunCtor = null;
        this.testRuns = {};
        this.allTestsCompletePromise = Promise.resolve();
        this.completeAllRunningTests = lodash_1.default;
        this.on('all-tests-complete', () => this.completeAllRunningTests());
    }
    get TestRunCtor() {
        if (!this._testRunCtor) {
            this._testRunCtor = test_run_1.TestRunCtorFactory({
                created: testRun => this._onTestRunCreated(testRun),
                done: (testRun, forced) => this._onTestRunDone(testRun, forced),
                readyToNext: testRun => this._onTestRunReadyToNext(testRun)
            });
        }
        return this._testRunCtor;
    }
    setExpectedTestCount(testCount) {
        this.expectedTestCount = testCount;
    }
    _getTestRuns() {
        return [].concat(...Object.values(this.testRuns));
    }
    run() {
        const readyToNextPromises = [];
        const testRuns = [].concat(...Object.values(this.testRuns));
        testRuns.forEach(testRun => {
            if (testRun.finish) {
                readyToNextPromises.push(testRun.readyToNextPromise);
                testRun.finish();
            }
        });
        this.testRuns = {};
        return Promise.all(readyToNextPromises);
    }
    stop() {
        this._getTestRuns().forEach(testRun => {
            testRun.stop();
        });
    }
    _getTestWrapper(test) {
        return this.testWrappers.find(w => w.test === test);
    }
    _onTestRunCreated(testRun) {
        this.allTestsCompletePromise = new Promise(resolve => {
            this.completeAllRunningTests = resolve;
        });
        const connectionId = testRun.browserConnection.id;
        this.testRuns[connectionId] = this.testRuns[connectionId] || [];
        this.testRuns[connectionId].push(testRun);
    }
    _onTestRunDone(testRun) {
        testRun.state = test_run_state_1.default.done;
        const hasRunningTests = this._getTestRuns().some(t => t.state !== test_run_state_1.default.done);
        if (!hasRunningTests)
            this.emit('all-tests-complete');
        const browserTestRuns = this.testRuns[testRun.browserConnection.id];
        testRun.readyToNextPromise = new Promise(resolve => {
            testRun.setReadyToNext = resolve;
        });
        if (browserTestRuns.length < this.expectedTestCount || browserTestRuns.some(t => t.state !== test_run_state_1.default.done))
            return Promise.resolve();
        return new Promise(resolve => {
            testRun.finish = () => {
                testRun.finish = null;
                testRun.state = test_run_state_1.default.done;
                resolve();
            };
        });
    }
    _onTestRunReadyToNext(testRun) {
        testRun.setReadyToNext();
    }
}
exports.default = LiveModeTestRunController;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1ydW4tY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL3Rlc3QtcnVuLWNvbnRyb2xsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxvREFBa0M7QUFDbEMsb0RBQTBCO0FBQzFCLHlDQUFnRDtBQUNoRCxzRUFBOEM7QUFFOUMsTUFBTSx5QkFBMEIsU0FBUSxnQkFBWTtJQUNoRDtRQUNJLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLFlBQVksR0FBUSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsWUFBWSxHQUFRLElBQUksQ0FBQztRQUU5QixJQUFJLENBQUMsUUFBUSxHQUFrQixFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLHVCQUF1QixHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNqRCxJQUFJLENBQUMsdUJBQXVCLEdBQUcsZ0JBQUksQ0FBQztRQUVwQyxJQUFJLENBQUMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVELElBQUksV0FBVztRQUNYLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxZQUFZLEdBQUcsNkJBQWtCLENBQUM7Z0JBQ25DLE9BQU8sRUFBTSxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUM7Z0JBQ3ZELElBQUksRUFBUyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQztnQkFDdEUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQzth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QyxDQUFDLENBQUMsS0FBSyxLQUFLLHdCQUFjLENBQUMsSUFBSSxDQUFDO1lBQzdHLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRTdCLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDekIsT0FBTyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7Z0JBQ2xCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO2dCQUN0QixPQUFPLENBQUMsS0FBSyxHQUFJLHdCQUFjLENBQUMsSUFBSSxDQUFDO2dCQUNyQyxPQUFPLEVBQUUsQ0FBQztZQUNkLENBQUMsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELHFCQUFxQixDQUFFLE9BQU87UUFDMUIsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzdCLENBQUM7Q0FDSjtBQUVELGtCQUFlLHlCQUF5QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IG5vb3AgZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFRlc3RSdW5DdG9yRmFjdG9yeSB9IGZyb20gJy4vdGVzdC1ydW4nO1xuaW1wb3J0IFRFU1RfUlVOX1NUQVRFIGZyb20gJy4vdGVzdC1ydW4tc3RhdGUnO1xuXG5jbGFzcyBMaXZlTW9kZVRlc3RSdW5Db250cm9sbGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy50ZXN0V3JhcHBlcnMgICAgICA9IFtdO1xuICAgICAgICB0aGlzLmV4cGVjdGVkVGVzdENvdW50ID0gMDtcbiAgICAgICAgdGhpcy5fdGVzdFJ1bkN0b3IgICAgICA9IG51bGw7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVucyAgICAgICAgICAgICAgICA9IHt9O1xuICAgICAgICB0aGlzLmFsbFRlc3RzQ29tcGxldGVQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuY29tcGxldGVBbGxSdW5uaW5nVGVzdHMgPSBub29wO1xuXG4gICAgICAgIHRoaXMub24oJ2FsbC10ZXN0cy1jb21wbGV0ZScsICgpID0+IHRoaXMuY29tcGxldGVBbGxSdW5uaW5nVGVzdHMoKSk7XG4gICAgfVxuXG4gICAgZ2V0IFRlc3RSdW5DdG9yICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl90ZXN0UnVuQ3Rvcikge1xuICAgICAgICAgICAgdGhpcy5fdGVzdFJ1bkN0b3IgPSBUZXN0UnVuQ3RvckZhY3Rvcnkoe1xuICAgICAgICAgICAgICAgIGNyZWF0ZWQ6ICAgICB0ZXN0UnVuID0+IHRoaXMuX29uVGVzdFJ1bkNyZWF0ZWQodGVzdFJ1biksXG4gICAgICAgICAgICAgICAgZG9uZTogICAgICAgICh0ZXN0UnVuLCBmb3JjZWQpID0+IHRoaXMuX29uVGVzdFJ1bkRvbmUodGVzdFJ1biwgZm9yY2VkKSxcbiAgICAgICAgICAgICAgICByZWFkeVRvTmV4dDogdGVzdFJ1biA9PiB0aGlzLl9vblRlc3RSdW5SZWFkeVRvTmV4dCh0ZXN0UnVuKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fdGVzdFJ1bkN0b3I7XG4gICAgfVxuXG4gICAgc2V0RXhwZWN0ZWRUZXN0Q291bnQgKHRlc3RDb3VudCkge1xuICAgICAgICB0aGlzLmV4cGVjdGVkVGVzdENvdW50ID0gdGVzdENvdW50O1xuICAgIH1cblxuICAgIF9nZXRUZXN0UnVucyAoKSB7XG4gICAgICAgIHJldHVybiBbXS5jb25jYXQoLi4uT2JqZWN0LnZhbHVlcyh0aGlzLnRlc3RSdW5zKSk7XG4gICAgfVxuXG4gICAgcnVuICgpIHtcbiAgICAgICAgY29uc3QgcmVhZHlUb05leHRQcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIGNvbnN0IHRlc3RSdW5zID0gW10uY29uY2F0KC4uLk9iamVjdC52YWx1ZXModGhpcy50ZXN0UnVucykpO1xuXG4gICAgICAgIHRlc3RSdW5zLmZvckVhY2godGVzdFJ1biA9PiB7XG4gICAgICAgICAgICBpZiAodGVzdFJ1bi5maW5pc2gpIHtcbiAgICAgICAgICAgICAgICByZWFkeVRvTmV4dFByb21pc2VzLnB1c2godGVzdFJ1bi5yZWFkeVRvTmV4dFByb21pc2UpO1xuICAgICAgICAgICAgICAgIHRlc3RSdW4uZmluaXNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bnMgPSB7fTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVhZHlUb05leHRQcm9taXNlcyk7XG4gICAgfVxuXG4gICAgc3RvcCAoKSB7XG4gICAgICAgIHRoaXMuX2dldFRlc3RSdW5zKCkuZm9yRWFjaCh0ZXN0UnVuID0+IHtcbiAgICAgICAgICAgIHRlc3RSdW4uc3RvcCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZ2V0VGVzdFdyYXBwZXIgKHRlc3QpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFdyYXBwZXJzLmZpbmQodyA9PiB3LnRlc3QgPT09IHRlc3QpO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5DcmVhdGVkICh0ZXN0UnVuKSB7XG5cbiAgICAgICAgdGhpcy5hbGxUZXN0c0NvbXBsZXRlUHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5jb21wbGV0ZUFsbFJ1bm5pbmdUZXN0cyA9IHJlc29sdmU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHRlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWQ7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuc1tjb25uZWN0aW9uSWRdID0gdGhpcy50ZXN0UnVuc1tjb25uZWN0aW9uSWRdIHx8IFtdO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bnNbY29ubmVjdGlvbklkXS5wdXNoKHRlc3RSdW4pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5Eb25lICh0ZXN0UnVuKSB7XG4gICAgICAgIHRlc3RSdW4uc3RhdGUgPSBURVNUX1JVTl9TVEFURS5kb25lO1xuXG4gICAgICAgIGNvbnN0IGhhc1J1bm5pbmdUZXN0cyA9IHRoaXMuX2dldFRlc3RSdW5zKCkuc29tZSh0ID0+IHQuc3RhdGUgIT09IFRFU1RfUlVOX1NUQVRFLmRvbmUpO1xuXG4gICAgICAgIGlmICghaGFzUnVubmluZ1Rlc3RzKVxuICAgICAgICAgICAgdGhpcy5lbWl0KCdhbGwtdGVzdHMtY29tcGxldGUnKTtcblxuICAgICAgICBjb25zdCBicm93c2VyVGVzdFJ1bnMgPSB0aGlzLnRlc3RSdW5zW3Rlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWRdO1xuXG4gICAgICAgIHRlc3RSdW4ucmVhZHlUb05leHRQcm9taXNlID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0ZXN0UnVuLnNldFJlYWR5VG9OZXh0ID0gcmVzb2x2ZTtcbiAgICAgICAgfSk7XG5cblxuICAgICAgICBpZiAoYnJvd3NlclRlc3RSdW5zLmxlbmd0aCA8IHRoaXMuZXhwZWN0ZWRUZXN0Q291bnQgfHwgYnJvd3NlclRlc3RSdW5zLnNvbWUodCA9PiB0LnN0YXRlICE9PSBURVNUX1JVTl9TVEFURS5kb25lKSlcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0ZXN0UnVuLmZpbmlzaCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0ZXN0UnVuLmZpbmlzaCA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGVzdFJ1bi5zdGF0ZSAgPSBURVNUX1JVTl9TVEFURS5kb25lO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5SZWFkeVRvTmV4dCAodGVzdFJ1bikge1xuICAgICAgICB0ZXN0UnVuLnNldFJlYWR5VG9OZXh0KCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBMaXZlTW9kZVRlc3RSdW5Db250cm9sbGVyO1xuIl19