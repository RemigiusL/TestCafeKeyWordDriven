"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = __importDefault(require("events"));
const file_watcher_1 = __importDefault(require("./file-watcher"));
const logger_1 = __importDefault(require("./logger"));
const process_1 = __importDefault(require("process"));
const readline_1 = __importDefault(require("readline"));
const REQUIRED_MODULE_FOUND_EVENT = 'require-module-found';
const LOCK_KEY_PRESS_TIMEOUT = 1000;
class LiveModeController extends events_1.default {
    constructor(runner) {
        super();
        this.src = null;
        this.running = false;
        this.restarting = false;
        this.watchingPaused = false;
        this.stopping = false;
        this.logger = new logger_1.default();
        this.runner = runner;
        this.lockKeyPress = false;
        this.fileWatcher = null;
        this.rl = null;
    }
    init(files) {
        this._listenKeyPress();
        this._initFileWatching(files);
        this._listenTestRunnerEvents();
        this._setRunning();
        return Promise.resolve()
            .then(() => this.logger.writeIntroMessage(files));
    }
    dispose() {
        this.fileWatcher.stop();
        process_1.default.stdin.setRawMode(false);
        this.rl.close();
    }
    _toggleWatching() {
        this.watchingPaused = !this.watchingPaused;
        this.logger.writeToggleWatchingMessage(!this.watchingPaused);
    }
    _stop() {
        if (!this.runner || !this.running) {
            this.logger.writeNothingToStopMessage();
            return Promise.resolve();
        }
        this.logger.writeStopRunningMessage();
        return this.runner.suspend()
            .then(() => {
            this.restarting = false;
            this.running = false;
        });
    }
    _restart() {
        if (this.restarting || this.watchingPaused)
            return Promise.resolve();
        this.restarting = true;
        if (this.running) {
            return this._stop()
                .then(() => this.logger.writeTestsFinishedMessage())
                .then(() => this._runTests());
        }
        return this._runTests();
    }
    _exit() {
        if (this.stopping)
            return Promise.resolve();
        this.logger.writeExitMessage();
        this.stopping = true;
        return this.runner ? this.runner.exit() : Promise.resolve();
    }
    _createFileWatcher(src) {
        return new file_watcher_1.default(src);
    }
    _listenKeyPress() {
        readline_1.default.emitKeypressEvents(process_1.default.stdin);
        if (process_1.default.stdin.isTTY)
            process_1.default.stdin.setRawMode(true);
        this.rl = readline_1.default.createInterface({
            input: process_1.default.stdin,
            output: process_1.default.stdout
        });
        process_1.default.stdin.on('keypress', (ch, key) => {
            if (this.lockKeyPress)
                return null;
            this.lockKeyPress = true;
            setTimeout(() => {
                this.lockKeyPress = false;
            }, LOCK_KEY_PRESS_TIMEOUT);
            if (key && key.ctrl) {
                switch (key.name) {
                    case 's':
                        return this._stop();
                    case 'r':
                        return this._restart();
                    case 'c':
                        return this._exit();
                    case 'w':
                        return this._toggleWatching();
                }
            }
            return null;
        });
    }
    _listenTestRunnerEvents() {
        this.runner.on(this.runner.TEST_RUN_DONE_EVENT, e => {
            this.running = false;
            if (!this.restarting)
                this.logger.writeTestsFinishedMessage();
            if (e.err)
                this.logger.err(e.err);
        });
        this.runner.on(this.runner.REQUIRED_MODULE_FOUND_EVENT, e => {
            this.emit(REQUIRED_MODULE_FOUND_EVENT, e);
        });
    }
    _initFileWatching(src) {
        this.fileWatcher = this._createFileWatcher(src);
        this.on(REQUIRED_MODULE_FOUND_EVENT, e => this.fileWatcher.addFile(e.filename));
        this.fileWatcher.on(this.fileWatcher.FILE_CHANGED_EVENT, () => this._runTests(true));
    }
    _setRunning() {
        this.running = true;
        this.restarting = false;
    }
    _runTests(sourceChanged) {
        if (this.watchingPaused || this.running)
            return Promise.resolve();
        this._setRunning();
        this.logger.writeRunTestsMessage(sourceChanged);
        return this.runner.runTests();
    }
}
exports.default = LiveModeController;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL2NvbnRyb2xsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxvREFBa0M7QUFDbEMsa0VBQXlDO0FBQ3pDLHNEQUE4QjtBQUM5QixzREFBOEI7QUFDOUIsd0RBQWdDO0FBRWhDLE1BQU0sMkJBQTJCLEdBQUcsc0JBQXNCLENBQUM7QUFDM0QsTUFBTSxzQkFBc0IsR0FBUSxJQUFJLENBQUM7QUFFekMsTUFBTSxrQkFBbUIsU0FBUSxnQkFBWTtJQUN6QyxZQUFhLE1BQU07UUFDZixLQUFLLEVBQUUsQ0FBQztRQUVSLElBQUksQ0FBQyxHQUFHLEdBQWMsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxPQUFPLEdBQVUsS0FBSyxDQUFDO1FBQzVCLElBQUksQ0FBQyxVQUFVLEdBQU8sS0FBSyxDQUFDO1FBQzVCLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1FBQzVCLElBQUksQ0FBQyxRQUFRLEdBQVMsS0FBSyxDQUFDO1FBQzVCLElBQUksQ0FBQyxNQUFNLEdBQVcsSUFBSSxnQkFBTSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLE1BQU0sR0FBVyxNQUFNLENBQUM7UUFDN0IsSUFBSSxDQUFDLFlBQVksR0FBSyxLQUFLLENBQUM7UUFDNUIsSUFBSSxDQUFDLFdBQVcsR0FBTSxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLEVBQUUsR0FBZSxJQUFJLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQUksQ0FBRSxLQUFLO1FBQ1AsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbkIsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFO2FBQ25CLElBQUks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QUFNLENBQUMsMkJBQTJCLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDeEQsSUFBSSxDQUFDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM5QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxpQkFBaUIsQ0FBRSxHQUFHO1FBQ2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWhELElBQUksQ0FBQyxFQUFFLENBQUMsMkJBQTJCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUVoRixJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxPQUFPLEdBQU0sSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQzVCLENBQUM7SUFFRCxTQUFTLENBQUUsYUFBYTtRQUNwQixJQUFJLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLE9BQU87WUFDbkMsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFN0IsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRW5CLElBQUksQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFaEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2xDLENBQUM7Q0FDSjtBQUVELGtCQUFlLGtCQUFrQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IEZpbGVXYXRjaGVyIGZyb20gJy4vZmlsZS13YXRjaGVyJztcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XG5pbXBvcnQgcmVhZGxpbmUgZnJvbSAncmVhZGxpbmUnO1xuXG5jb25zdCBSRVFVSVJFRF9NT0RVTEVfRk9VTkRfRVZFTlQgPSAncmVxdWlyZS1tb2R1bGUtZm91bmQnO1xuY29uc3QgTE9DS19LRVlfUFJFU1NfVElNRU9VVCAgICAgID0gMTAwMDtcblxuY2xhc3MgTGl2ZU1vZGVDb250cm9sbGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocnVubmVyKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5zcmMgICAgICAgICAgICA9IG51bGw7XG4gICAgICAgIHRoaXMucnVubmluZyAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZXN0YXJ0aW5nICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLndhdGNoaW5nUGF1c2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc3RvcHBpbmcgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5sb2dnZXIgICAgICAgICA9IG5ldyBMb2dnZXIoKTtcbiAgICAgICAgdGhpcy5ydW5uZXIgICAgICAgICA9IHJ1bm5lcjtcbiAgICAgICAgdGhpcy5sb2NrS2V5UHJlc3MgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLmZpbGVXYXRjaGVyICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5ybCAgICAgICAgICAgICA9IG51bGw7XG4gICAgfVxuXG4gICAgaW5pdCAoZmlsZXMpIHtcbiAgICAgICAgdGhpcy5fbGlzdGVuS2V5UHJlc3MoKTtcbiAgICAgICAgdGhpcy5faW5pdEZpbGVXYXRjaGluZyhmaWxlcyk7XG4gICAgICAgIHRoaXMuX2xpc3RlblRlc3RSdW5uZXJFdmVudHMoKTtcbiAgICAgICAgdGhpcy5fc2V0UnVubmluZygpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5sb2dnZXIud3JpdGVJbnRyb01lc3NhZ2UoZmlsZXMpKTtcbiAgICB9XG5cbiAgICBkaXNwb3NlICgpIHtcbiAgICAgICAgdGhpcy5maWxlV2F0Y2hlci5zdG9wKCk7XG4gICAgICAgIHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZShmYWxzZSk7XG4gICAgICAgIHRoaXMucmwuY2xvc2UoKTtcbiAgICB9XG5cbiAgICBfdG9nZ2xlV2F0Y2hpbmcgKCkge1xuICAgICAgICB0aGlzLndhdGNoaW5nUGF1c2VkID0gIXRoaXMud2F0Y2hpbmdQYXVzZWQ7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIud3JpdGVUb2dnbGVXYXRjaGluZ01lc3NhZ2UoIXRoaXMud2F0Y2hpbmdQYXVzZWQpO1xuICAgIH1cblxuICAgIF9zdG9wICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJ1bm5lciB8fCAhdGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53cml0ZU5vdGhpbmdUb1N0b3BNZXNzYWdlKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubG9nZ2VyLndyaXRlU3RvcFJ1bm5pbmdNZXNzYWdlKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucnVubmVyLnN1c3BlbmQoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVzdGFydGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMucnVubmluZyAgICA9IGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3Jlc3RhcnQgKCkge1xuICAgICAgICBpZiAodGhpcy5yZXN0YXJ0aW5nIHx8IHRoaXMud2F0Y2hpbmdQYXVzZWQpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgdGhpcy5yZXN0YXJ0aW5nID0gdHJ1ZTtcblxuICAgICAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RvcCgpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5sb2dnZXIud3JpdGVUZXN0c0ZpbmlzaGVkTWVzc2FnZSgpKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuX3J1blRlc3RzKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3J1blRlc3RzKCk7XG4gICAgfVxuXG4gICAgX2V4aXQgKCkge1xuICAgICAgICBpZiAodGhpcy5zdG9wcGluZylcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcblxuICAgICAgICB0aGlzLmxvZ2dlci53cml0ZUV4aXRNZXNzYWdlKCk7XG5cbiAgICAgICAgdGhpcy5zdG9wcGluZyA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucnVubmVyID8gdGhpcy5ydW5uZXIuZXhpdCgpIDogUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZUZpbGVXYXRjaGVyIChzcmMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGaWxlV2F0Y2hlcihzcmMpO1xuICAgIH1cblxuICAgIF9saXN0ZW5LZXlQcmVzcyAoKSB7XG4gICAgICAgIHJlYWRsaW5lLmVtaXRLZXlwcmVzc0V2ZW50cyhwcm9jZXNzLnN0ZGluKTtcbiAgICAgICAgaWYgKHByb2Nlc3Muc3RkaW4uaXNUVFkpXG4gICAgICAgICAgICBwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUodHJ1ZSk7XG5cbiAgICAgICAgdGhpcy5ybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSh7XG4gICAgICAgICAgICBpbnB1dDogIHByb2Nlc3Muc3RkaW4sXG4gICAgICAgICAgICBvdXRwdXQ6IHByb2Nlc3Muc3Rkb3V0XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ub24oJ2tleXByZXNzJywgKGNoLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmxvY2tLZXlQcmVzcylcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICAgICAgdGhpcy5sb2NrS2V5UHJlc3MgPSB0cnVlO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2tLZXlQcmVzcyA9IGZhbHNlO1xuICAgICAgICAgICAgfSwgTE9DS19LRVlfUFJFU1NfVElNRU9VVCk7XG5cbiAgICAgICAgICAgIGlmIChrZXkgJiYga2V5LmN0cmwpIHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleS5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3MnOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0b3AoKTtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAncic6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVzdGFydCgpO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdjJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9leGl0KCk7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3cnOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RvZ2dsZVdhdGNoaW5nKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2xpc3RlblRlc3RSdW5uZXJFdmVudHMgKCkge1xuICAgICAgICB0aGlzLnJ1bm5lci5vbih0aGlzLnJ1bm5lci5URVNUX1JVTl9ET05FX0VWRU5ULCBlID0+IHtcbiAgICAgICAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMucmVzdGFydGluZylcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci53cml0ZVRlc3RzRmluaXNoZWRNZXNzYWdlKCk7XG5cbiAgICAgICAgICAgIGlmIChlLmVycilcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnIoZS5lcnIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnJ1bm5lci5vbih0aGlzLnJ1bm5lci5SRVFVSVJFRF9NT0RVTEVfRk9VTkRfRVZFTlQsIGUgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbWl0KFJFUVVJUkVEX01PRFVMRV9GT1VORF9FVkVOVCwgZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9pbml0RmlsZVdhdGNoaW5nIChzcmMpIHtcbiAgICAgICAgdGhpcy5maWxlV2F0Y2hlciA9IHRoaXMuX2NyZWF0ZUZpbGVXYXRjaGVyKHNyYyk7XG5cbiAgICAgICAgdGhpcy5vbihSRVFVSVJFRF9NT0RVTEVfRk9VTkRfRVZFTlQsIGUgPT4gdGhpcy5maWxlV2F0Y2hlci5hZGRGaWxlKGUuZmlsZW5hbWUpKTtcblxuICAgICAgICB0aGlzLmZpbGVXYXRjaGVyLm9uKHRoaXMuZmlsZVdhdGNoZXIuRklMRV9DSEFOR0VEX0VWRU5ULCAoKSA9PiB0aGlzLl9ydW5UZXN0cyh0cnVlKSk7XG4gICAgfVxuXG4gICAgX3NldFJ1bm5pbmcgKCkge1xuICAgICAgICB0aGlzLnJ1bm5pbmcgICAgPSB0cnVlO1xuICAgICAgICB0aGlzLnJlc3RhcnRpbmcgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBfcnVuVGVzdHMgKHNvdXJjZUNoYW5nZWQpIHtcbiAgICAgICAgaWYgKHRoaXMud2F0Y2hpbmdQYXVzZWQgfHwgdGhpcy5ydW5uaW5nKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIHRoaXMuX3NldFJ1bm5pbmcoKTtcblxuICAgICAgICB0aGlzLmxvZ2dlci53cml0ZVJ1blRlc3RzTWVzc2FnZShzb3VyY2VDaGFuZ2VkKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5ydW5uZXIucnVuVGVzdHMoKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IExpdmVNb2RlQ29udHJvbGxlcjtcbiJdfQ==